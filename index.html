<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <script src="safefile.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Was that Infinite? â€” Local Prototype</title>
  <style>
        @font-face{
  font-family:'GlowSansTC';
  src:url('GlowSansTC-subset.woff2') format('woff2');
  font-weight:100 900;
  font-style:normal;
  font-display:swap;
}
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');
    :root{
      --bg:#0f1115; --panel:#141823; --card:#1a2030; --muted:#9aa0a6; --fg:#e9eef5; --accent:#6dd5fa; --accent2:#7f53ac;
      --good:#19c37d; --warn:#ffb020; --bad:#ff5d5d; --glow:0 0 0 1px rgba(255,255,255,.06),0 10px 30px rgba(0,0,0,.45);
    }
    html,body{height:100%}

body {
  margin:0;
  background:radial-gradient(1200px 1200px at 0% 0%,#121726 0%,#0f1115 50%,#0b0d12 100%);
  color:var(--fg);
  font-family: "Noto Sans TC", sans-serif;
  font-size: 16px;
  line-height: 1.4;
}

    .app{display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:auto 1fr auto;grid-template-areas:
      'header header header'
      'left main right'
      'footer footer footer';height:100vh}

    header{grid-area:header;display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #202637;background:#0e1320;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;letter-spacing:.3px;font-weight:700}
    header .actions{margin-left:auto;display:flex;gap:8px}
    button, .btn{background:linear-gradient(135deg,rgba(125,146,255,.12),rgba(125,146,255,.05));border:1px solid #2b3350;color:var(--fg);padding:8px 10px;border-radius:12px;cursor:pointer;box-shadow:var(--glow);transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:#111726;border:1px solid #28304a;color:var(--muted)}

    .left{grid-area:left;background:var(--panel);border-right:1px solid #22283d;display:flex;flex-direction:column;min-height:0}
    .left .search{padding:10px;display:flex;gap:8px;align-items:center}
    .left input{flex:1;width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3350;background:#0f1422;color:var(--fg)}
    .catalog{padding:8px 10px;overflow:auto;display:grid;grid-template-columns:1fr 1fr;gap:8px;perspective: 1000px;
  perspective-origin: center center;}

    .card{
  user-select:none;
  background:linear-gradient(180deg,#1b2233,#151b29);
  border:1px solid #2a3250;
  border-radius:14px;
  padding:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  box-shadow:var(--glow);
  cursor:grab;
  
  /* æ–°å¢ 3D Transform Setup */
  transform-style: preserve-3d;
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  position: relative;
  
  /* æ–°å¢åŸºç¤æµ®å‹•å‹•ç•« */
  animation: cardFloat 4s ease-in-out infinite;
}
@keyframes cardFloat {
  0%, 100% { 
    transform: translateY(0px) rotateX(0deg) rotateY(0deg); 
  }
  50% { 
    transform: translateY(-2px) rotateX(1deg) rotateY(0.5deg); 
  }
}
.card:hover {
  transform: translateY(-8px) rotateX(15deg) scale(1.05);
  box-shadow: 
    var(--glow),
    0 20px 40px rgba(0, 0, 0, 0.3),
    0 0 20px rgba(109, 213, 250, 0.1);
  animation: none;
}

/* æ–°å¢æ»‘é¼ è·Ÿéš¨æ•ˆæœ */
.card.tilt-active {
  transition: transform 0.1s ease-out;
}
.card.dragging {
  transform: none !important;
  animation: none !important;
}
/* æ–°å¢å¡ç‰‡å‹•ç•«å»¶é² */
.card:nth-child(odd) { animation-delay: -1s; }
.card:nth-child(3n) { animation-delay: -2s; }
.card:nth-child(4n) { animation-delay: -0.5s; }
    .card.your{outline:2px solid #b78cff; box-shadow:0 0 12px rgba(183,140,255,.45), var(--glow)}
    .card:active{cursor:grabbing}
    .emoji{font-size:28px}
    .name{font-size:12px;color:#c7d0dd;text-align:center}

    .main{grid-area:main;position:relative;display:grid;grid-template-rows:1fr 220px}
    .board{position:relative;overflow:hidden}
    .dropzone{position:absolute;inset:0;display:grid;place-items:center;border:2px dashed #2a3250;border-radius:16px;margin:16px;background:linear-gradient(180deg,rgba(109,213,250,.08),rgba(127,83,172,.08))}
    .dropzone .hint{opacity:.8;color:var(--muted)}

    .workspace{position:absolute;inset:0;margin:16px;border-radius:16px;pointer-events:none}
    .token{position:absolute;pointer-events:auto;transform:translate(-50%,-50%);}
    .token .card{padding:8px 10px}

    .combos{border-top:1px solid #22283d;background:#0e1423;overflow:auto}
    .combos h3{margin:10px 14px;font-size:13px;color:#aab4c8}
    .combo-log{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;padding:10px}
    .combo{background:#131a2b;border:1px solid #26304e;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .combo .mini{display:flex;align-items:center;gap:6px}
    .mini .emoji{font-size:18px}

    .right{grid-area:right;background:var(--panel);border-left:1px solid #22283d;display:flex;flex-direction:column;min-height:0}
    .right h3{margin:10px 14px;font-size:13px;color:#aab4c8}
    .book{padding:10px;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;
      perspective: 1000px; perspective-origin: center center;}
    .panel{border-top:1px solid #22283d;background:#0e1423;padding:10px 12px;display:grid;gap:8px}
    .progress{height:8px;background:#0c1220;border:1px solid #26304e;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#6dd5fa,#7f53ac)}
    .missions{display:grid;gap:6px}
    .mission{display:flex;align-items:center;gap:8px;background:#11182a;border:1px solid #22304c;padding:6px 8px;border-radius:10px}
    .mission .done{opacity:.5;text-decoration:line-through}

    footer{grid-area:footer;border-top:1px solid #22283d;background:#0e1320;color:var(--muted);padding:8px 12px;display:flex;align-items:center;gap:10px}

    .toast{position:fixed;right:16px;bottom:16px;background:#0e1423;border:1px solid #2a3352;color:#eaf2ff;padding:10px 12px;border-radius:12px;box-shadow:var(--glow);opacity:0;transform:translateY(8px);transition:all .25s ease;z-index:99}
    .toast.show{opacity:1;transform:translateY(0)}
    .sparkle{position:absolute;font-size:18px;pointer-events:none;animation:spark .8s ease forwards}
    @keyframes spark{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}40%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-70%) scale(.3)}}
    .emoji-container {
  display: flex;
  justify-content: center; /* æ°´å¹³å±…ä¸­ */
  align-items: center;     /* å‚ç›´å±…ä¸­ */
  gap: 4px;               /* emoji ä¹‹é–“çš„é–“è· */
}
.token { transition: opacity 0.25s ease; }
.token.fade-out { opacity: 0; }
.emoji {font-size: 28px;}
/* Intro cutscene */
.intro{position:fixed;inset:0;background:#000;color:#e9eef5;
  display:flex;align-items:center;justify-content:center;z-index:9999;
  opacity:1;transition:opacity .8s ease}
.intro.hidden{display:none}
.intro.fade{opacity:0}
.intro-inner{position:relative;max-width:70ch;padding:32px 28px;
  font-size:18px;line-height:1.75;letter-spacing:.2px}
.intro-text{white-space:pre-line;text-align:center}

/* è¦–è¦ºé›œè¨Šæƒæç·š */
.intro .scan{pointer-events:none;position:absolute;inset:-8px;border-radius:8px;
  background:repeating-linear-gradient( to bottom,
    rgba(255,255,255,.045) 0, rgba(255,255,255,.045) 1px,
    transparent 2px, transparent 3px); mix-blend-mode:overlay;
  animation:introScan 7.5s linear infinite; opacity:.18}
@keyframes introScan{from{transform:translateY(-100%)}to{transform:translateY(100%)}}
.intro::after{
  content:"";
  position:absolute; inset:0; pointer-events:none; opacity:.10;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  animation:introNoise .25s steps(2) infinite;
}
    /* tiny test panel */
    #testPanel{position:fixed;left:10px;bottom:10px;max-width:44ch;background:#0e1423;border:1px solid #2a3352;color:#cfe2ff;padding:8px 10px;border-radius:10px;box-shadow:var(--glow);font-size:12px;opacity:.9}
    #testPanel summary{cursor:pointer;color:#9cc0ff}
      /* armed reset visual */
    #resetBtn.armed{ border-color:#ff4d4f !important; background:linear-gradient(135deg, rgba(255,77,79,.18), rgba(255,77,79,.08)); color:#ffecec }
.intro, .intro * {
  font-family: 'GlowSansTC' sans-serif;
}


  </style>
</head>
<body>
  <audio id="introBgm" src="cosmic.wav" preload="auto" playsinline></audio>

  <div class="app">
    <header>
      <h1>Was that Infinite? <span class="pill">Local Prototype</span></h1>
      <div class="actions">
        <button id="exportBtn" title="åŒ¯å‡ºè³‡æ–™">åŒ¯å‡º</button>
        <button id="importBtn" title="åŒ¯å…¥è³‡æ–™">åŒ¯å…¥</button>
        <button id="resetBtn" title="é‡ç½®æ‰€æœ‰é€²åº¦" style="border-color:#4a2030">é‡ç½®</button>
      </div>
    </header>

    <aside class="left">
      <div class="search">
        <input id="search" placeholder="æœå°‹åŸºç¤å…ƒç´ æˆ–å·²è§£é–ç‰©å“" />
        <span class="pill" id="statsPill">â€”</span>
      </div>
      <div id="catalog" class="catalog"></div>
    </aside>

    <main class="main">
      <section class="board">
        <div class="dropzone" id="dropzone"><div class="hint">æŠŠå…©å€‹å¡ç‰‡æ‹–é€²ä¾†åˆæˆ</div></div>
        <div class="workspace" id="workspace"></div>
      </section>
      <section class="combos">
        <h3>åˆæˆç´€éŒ„</h3>
        <div id="comboLog" class="combo-log"></div>
      </section>
    </main>

    <aside class="right">
      <h3>æ”¶é›†å†Š</h3>
      <div id="book" class="book"></div>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong style="font-size:13px;color:#cfe2ff">é€²åº¦</strong>
          <button id="rerollMissions" class="btn" style="padding:6px 8px;font-size:12px">é‡æ“²ä»»å‹™</button>
        </div>
        <div class="progress"><div id="progressBar" class="bar" style="width:0%"></div></div>
        <div class="missions" id="missions"></div>
      </div>
    </aside>

    <footer>
      <span>æœ¬åœ°å„²å­˜ v9.1<span id="ver"></span> â€¢ å¾Œç«¯é–‹ç™¼ä¸­ â€¢ æ”¯æ´ new discover</span>
    </footer>
  </div>

  <div id="toast" class="toast"></div>
<!-- CUTSCENE: Intro -->
<div id="intro" class="intro hidden">
  <div class="intro-inner">
    <div class="scan"></div>
    <div class="intro-text" id="introText"></div>
  </div>
</div>

  <script>
    // ---------- Versioning ----------
    const SAVE_VERSION = 9.1;

    // ---------- Robust JSON helpers ----------
    function safeParseJSON(raw){
      try{
        if(raw == null) return {ok:true, val:null};
        if(typeof raw !== 'string') return {ok:false, err:'not-string'};
        const s = raw.trim();
        if(s === '' || s === 'null' || s === 'undefined') return {ok:true, val:null};
        return {ok:true, val: JSON.parse(s)};
      }catch(err){ return {ok:false, err}; }
    }

    function isPlainObject(o){ return Object.prototype.toString.call(o) === '[object Object]'; }

    function validateState(s){
      if(!s) return false;
      if(!isPlainObject(s.known) || !isPlainObject(s.unlocked) || !Array.isArray(s.history)) return false;
      if(!('version' in s)) s.version = 1; // migrate older saves
      if(!Array.isArray(s.missions)) s.missions = [];
      return true;
    }

    // ---------- Persistence Layer ----------
    const LS_KEY = 'iec_save_v1';
    function saveState(){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      catch(e){ console.warn('saveState failed', e); toast('å„²å­˜å¤±æ•—ï¼šé…é¡æˆ–ç€è¦½å™¨é™åˆ¶'); }
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const parsed = safeParseJSON(raw);
        if(!parsed.ok){ console.warn('loadState: corrupted raw', parsed.err); return null; }
        const val = parsed.val;
        if(!validateState(val)) return null;
        // migrate
        if(val.version < SAVE_VERSION){ val.version = SAVE_VERSION; }
        return val;
      }catch(e){
        console.warn('loadState: exception, wipe bad save', e);
        try{ localStorage.removeItem(LS_KEY); }catch{ /* ignore */ }
        return null;
      }
    }

    // ---------- Data ----------
const firstPool = [
  ['æ°´',['ğŸ’§']], ['ç«',['ğŸ”¥']], ['åœŸ',['ğŸŸ«']], ['é¢¨',['ğŸ’¨']]
];
const seedRecipes = {
  'æ°´+åœŸ':['æ³¥',['ğŸŸ¤']],
  'ç«+ç«':['çƒˆç„°',['ğŸ”¥','ğŸ”¥']],
  'æ°´+æ°´':['æ²³',['ğŸ’§','ğŸŒŠ']],
  'ç«+æ°´':['è’¸æ°£',['ğŸ’¨']],
  'é¢¨+é¢¨':['é¢¶é¢¨',['ğŸ’¨','ğŸ’¨']],
  'æœˆçƒ+æ°´':['æœˆæ³‰',['ğŸŒ•','ğŸ’§']],
  'æ²³+çŸ³é ­':['æ²™',['ğŸœï¸']],
  'æµ·+æ¨¹':['çŠç‘š',['ğŸª¸']],
  'ç†”çˆ+é›œé‡‘å±¬':['ç´”é‡‘å±¬',['âš™ï¸']],
  'çŸ³é ­+é›œé‡‘å±¬':['éµç¤¦',['ğŸª¨','âš™ï¸']],
  'ç£éµç¤¦+é›œé‡‘å±¬':['é›»',['ğŸª¨','ğŸ§²']],
  'éµç¤¦+çŸ³é ­':['ç£éµç¤¦',['ğŸª¨','ğŸ§²']],
  'æ°´+æ³¥':['æ³¥æ¼¿',['ğŸŸ¤','ğŸ’§']],
  'æ°´+æ²™':['æ³¥æ¼¿',['ğŸŸ¤','ğŸ’§']],
  'é¢¨+æ²™':['æ²™å¡µæš´',['ğŸ’¨','ğŸª¨']],
  'é¢¨+é›œé‡‘å±¬':['é¢¨è»Š',['ğŸ’¨','ğŸª¨']],
  'ç«+ç…™':['ç°ç‡¼',['ğŸ”¥','ğŸŒ«ï¸']],
  'ç°ç‡¼+æ°´':['ç°æ°´',['ğŸŒ«ï¸','ğŸ’§']],  
  'ç°ç‡¼+åœŸ':['æ²ƒå£¤',['ğŸŸ«','âœ¨']],
  'æ²ƒå£¤+æ¤ç‰©':['ä½œç‰©',['ğŸŒ¾']],
  'æ²³+æ²³':['æ¹–',['ğŸ’§','ğŸï¸']],
  'æ¹–+æ¹–':['æµ·',['ğŸŒŠ']],
  'æ³¥+å…‰':['ç´°èƒ',['ğŸ¦ ']],
  'ç´°èƒ+ç´°èƒ':['ç”Ÿå‘½',['ğŸŒ±']],
  'é¢¨+æ³¥':['æ³¥æ²™æš´',['ğŸ’¨','ğŸŸ¤']],
  'ç´°èƒ+æ°´':['æ°´ç´°èƒ',['ğŸ¦ ','ğŸ’§']],
  'ç´°èƒ+åœŸ':['åœŸç´°èƒ',['ğŸ¦ ','ğŸŸ«']],
  'ç´°èƒ+é¢¨':['é¢¨ç´°èƒ',['ğŸ¦ ','ğŸ’¨']],
  'æ°´æ³¥+ç£š':['ç‰†',['ğŸ§±','ğŸ—ï¸']],
  'ç´°èƒ+ç«':['ç«ç´°èƒ',['ğŸ¦ ','ğŸ”¥']],
  'ç«+åœŸ':['ç£š',['ğŸ§±']],
  'ç”Ÿå‘½+å…‰':['éˆé­‚',['ğŸ‘»']],
  'éˆé­‚+ç´°èƒ':['æ™ºæ…§',['ğŸ§ ']],
  'ç«+æ³¥':['é»åœŸ',['ğŸŸ¤','ğŸª¨']],
  'ç‰†+å¤©ç©º':['å¤©èŠ±æ¿',['ğŸ ','â¬œ']],
  'å¤©èŠ±æ¿+ç‰†':['æˆ¿é–“',['ğŸ ','ğŸšª']],
  'ç«+é»åœŸ':['æ°´æ³¥',['ğŸ§±','ğŸª¨']],
  'åœŸ+åœŸ':['çŸ³é ­',['ğŸª¨']],
  'çŸ³é ­+ç«':['é›œé‡‘å±¬',['âš™ï¸']],
  'é¢¨+ç«':['ç…™',['ğŸŒ«ï¸']],
  'é¢¨+æ°´':['é›²',['â˜ï¸']],
  'ç«+å¡µåŸƒ':['ç«è—¥',['ğŸ§¨']],
  'é›²+é¢¨':['å¤©ç©º',['ğŸŒˆ']],
  'é›²+é›»':['é›·',['ğŸŒ©ï¸']],
  'é¢¨+é›¨':['æš´é›¨',['â›ˆï¸']],
  'é¢¨+åœŸ':['å¡µåŸƒ',['ğŸ’¨','ğŸŸ«']],
  'é›²+æ°´':['é›¨',['ğŸŒ§ï¸']],
  'ä½éšæ©Ÿå™¨+ç«è—¥':['ç«ç¹©æ§',['ğŸ”«','ğŸ§¨']],
  'ç«ç¹©æ§+ç´”é‡‘å±¬':['é‚ç™¼æ§',['ğŸ”«','ğŸ§¨']],
  'å¤©ç©º+ç«':['å¤ªé™½',['â˜€ï¸']],
  'å¤©ç©º+é›»':['å…‰',['âœ¨']],
  'å¤©ç©º+å…‰':['æœˆçƒ',['ğŸŒ•']],
  'å¤ªé™½+æœˆçƒ':['æ™‚é–“',['âŒ›ï¸']],
  'ç”Ÿå‘½+åœŸ':['æ¤ç‰©',['ğŸŒ¿']],
  'æ¤ç‰©+æ™‚é–“':['æ¨¹',['ğŸŒ³']],
  'é›»+æ°´': ['é›»è§£æ°´',['âš¡','ğŸ’§']],
  'æ¤ç‰©+é›¨':['èŠ±æœµ',['ğŸŒ¸']],
  'æ¤ç‰©+æ°´':['æ°´ç”Ÿæ¤ç‰©',['ğŸ’§','ğŸŒ¿']],
  'é›œé‡‘å±¬+é›»':['ä½éšæ©Ÿå™¨',['ğŸ¤–']],
  'ç´”é‡‘å±¬+é›»':['é«˜éšæ©Ÿå™¨',['ğŸ¤–']],
  'æ°´+æ™‚é–“':['å†°',['ğŸ§Š']],
  'æ°´+å†°':['é›ª',['â„ï¸']],
  'ç«+é›œé‡‘å±¬':['ç†”çˆ',['ğŸ”¥','ğŸ­']],
  'ç”Ÿå‘½+æ°´':['é­š',['ğŸŸ']],
  'é­š+é›»':['é›»é°»',['ğŸŸ','âš¡']],
  'åœŸ+æ™‚é–“':['åŒ–çŸ³',['ğŸ¦´']],
  'ç”Ÿå‘½+ç´”é‡‘å±¬':['è³½åš',['ğŸ§¬','ğŸ¤–']]
};


const elementDisplay = {
  //æ§åˆ¶åœ–ç‰‡or emoji
  'é¾ä¹‹å¿ƒ': {
    showEmoji: false,
    showImage: true,
    image: 'images/special/dragon_heart.png'
  },
};

// ========== ç®¡ç†å‡½æ•¸ ==========
// å‹•æ…‹èª¿æ•´é¡¯ç¤ºæ¨¡å¼
function setDisplayMode(elementName, mode) {
  const modes = {
    'emoji-only': { showEmoji: true, showImage: false },
    'image-only': { showEmoji: false, showImage: true },
    'mixed': { showEmoji: true, showImage: true },
    'auto': { showEmoji: true, showImage: true }
  };
  
  if (modes[mode]) {
    if (!elementDisplay[elementName]) elementDisplay[elementName] = {};
    Object.assign(elementDisplay[elementName], modes[mode]);
  }
}


function debugElementDisplay(elementName) {
  const config = getElementDisplayConfig(elementName);
  console.log(`${elementName} é¡¯ç¤ºé…ç½®:`, config);
}


async function preloadElementImages() {
  const imagesToLoad = new Set();
  
  Object.values(elementDisplay).forEach(config => {
    if (config.image) imagesToLoad.add(config.image);
    if (config.images) config.images.forEach(img => imagesToLoad.add(img));
  });
  
  console.log(`é–‹å§‹é è¼‰å…¥ ${imagesToLoad.size} å¼µåœ–ç‰‡...`);
  
  const loadPromises = [...imagesToLoad].map(src => {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => resolve({ src, success: true });
      img.onerror = () => resolve({ src, success: false });
      img.src = src;
    });
  });
  
  const results = await Promise.all(loadPromises);
  const successful = results.filter(r => r.success).length;
  
  console.log(`é è¼‰å…¥å®Œæˆ: ${successful}/${results.length} å¼µåœ–ç‰‡æˆåŠŸ`);
  const failed = results.filter(r => !r.success);
  if (failed.length > 0) {
    console.warn('è¼‰å…¥å¤±æ•—çš„åœ–ç‰‡:', failed.map(f => f.src));
  }
  
  return { total: results.length, successful, failed: failed.length };
}
// åˆå§‹åŒ–

preloadElementImages();

function getElementDisplayConfig(name, isRare = false) {
  const config = elementDisplay[name];
  if (!config) {
    // é è¨­åªæä¾›é¡¯ç¤ºæ¨¡å¼ï¼Œä¸æä¾› emojiï¼Œé¿å…è¦†è“‹å‚³å…¥å€¼
    return { showEmoji: true, showImage: false };
  }
  return {
    ...config,
    emoji: config.customEmoji || resultEmojiMap[name] || pickEmojiByName(name)
  };
}
function createImageElement(container, imageSrc, name, config) {
  const wrapper = document.createElement('div');
  wrapper.className = 'emoji custom-image';
  
  const img = document.createElement('img');
  img.src = imageSrc;
  img.alt = name;
  img.width = 28;
  img.height = 28;
  
  img.onerror = function() {
    console.warn(`Image failed to load: ${imageSrc}`);
    
    if (config.fallbackEmoji) {
      
      wrapper.innerHTML = '';
      wrapper.className = 'emoji';
      
      config.fallbackEmoji.forEach(emoji => {
        const emojiEl = createSingleEmojiElement(emoji);
        wrapper.appendChild(emojiEl);
      });
    } else {
      // ç›´æ¥ç§»é™¤å¤±æ•—çš„åœ–ç‰‡
      wrapper.remove();
    }
  };
  
  wrapper.appendChild(img);
  container.appendChild(wrapper);
  return wrapper;
}
function createSingleEmojiElement(emoji) {
  const emojiEl = document.createElement('div');
  emojiEl.className = 'emoji';

  if (isApplePlatform()) {
    emojiEl.textContent = emoji;
  } else {
    let imgNode;
    if (emojiImgCache.has(emoji)) {
      imgNode = emojiImgCache.get(emoji).cloneNode(true);
    } else {
      const img = document.createElement('img');
      img.src = `https://emojicdn.elk.sh/${encodeURIComponent(emoji)}?style=apple&size=64`;
      img.alt = emoji;
      img.width = 28;
      img.height = 28;
      emojiImgCache.set(emoji, img);
      imgNode = img.cloneNode(true);
    }
    emojiEl.appendChild(imgNode);
  }

  return emojiEl;
}
function createEmojiElements(container, emojiList) {
  const list = Array.isArray(emojiList) ? emojiList : [emojiList];
  
  list.forEach(emoji => {
    const emojiEl = createSingleEmojiElement(emoji);
    container.appendChild(emojiEl);
  });
}
const normPair = (a,b) => [a,b].sort().join('+');
const seedMap = {};
for (const [k, v] of Object.entries(seedRecipes)) {
  const [a, b] = k.split('+');
  seedMap[normPair(a, b)] = v; // v å½¢å¦‚ ['æ³¥',['ğŸŸ¤']]
}
const resultEmojiMap = {};
for (const [k, v] of Object.entries(seedRecipes)) {
  const [name, emoji] = v;                 // v å½¢å¦‚ ['æ³¥', ['ğŸŸ¤']]
  resultEmojiMap[name] = Array.isArray(emoji) ? emoji : [emoji];
}
      const rules = [
    [/é»‘æ´|å®‡å®™|éŠ€æ²³|æ˜Ÿç³»|è¡Œæ˜Ÿ|æ†æ˜Ÿ|æ˜Ÿ|å½—æ˜Ÿ/, ['ğŸª']],
    [/æ°´|æ³‰|é›¨|æ»´/, ['ğŸ’§']],
    [/æµ·|æ½®|æµª|æ´‹/, ['ğŸŒŠ']],
    [/æ²³|æ¹–/, ['ğŸï¸']],             
    [/æ¨¹|æ—|æœ¨|æ£®|æ¾|æŸ/, ['ğŸŒ²']],
    [/èŠ±|ç“£|æ«»|æ¢…|èŠ|è“®|è˜­/, ['ğŸŒ¸']],
    [/èŸ²|å¹¼èŸ²/, ['ğŸ›']],
    [/è¶/, ['ğŸ¦‹']],
    [/ç”²èŸ²|é¬å½¢èŸ²|é‡‘é¾œå­/, ['ğŸª²']],
    [/èœ‚/, ['ğŸ']],
    [/èèŸ»|èŸ»/, ['ğŸœ']],
    [/èšŠ/, ['ğŸ¦Ÿ']],
    [/ç“¢èŸ²/, ['ğŸ']],
    [/ç£|ç£éµ|ç£å ´/, ['ğŸ§²']],
    [/å†°|çµå†°/, ['ğŸ§Š']],
    [/é›ª|éœœ|å¯’/, ['â„ï¸']], 
    [/ç«|ç‚|ç„°|ç†”|ç†±|ç†¾|ç‡„/, ['ğŸ”¥']],
    [/é›»|é›·|é–ƒé›»|é›»æ“Š/, ['âš¡']],
    [/æœ|è˜‹æœ/, ['ğŸ']],
    [/è‘¡è„/, ['ğŸ‡']],
    [/é³¥|é·¹|éš¼/, ['ğŸ¦…']],
    [/é´¨|éµ|é›/, ['ğŸ¦†']],
    [/è›‡|èŸ’/, ['ğŸ']],
    [/é¾œ|æµ·é¾œ/, ['ğŸ¢']],
    [/èœ¥|èœ¥èœ´/, ['ğŸ¦']],
    [/è›™|é’è›™|èŸ¾èœ/, ['ğŸ¸']],
    [/é¶´/, ['ğŸ¦']],
    [/é´¿/, ['ğŸ•Šï¸']],
    [/é›|é››/, ['ğŸ”']],
    [/å­”é›€/, ['ğŸ¦š']],
    [/ä¼éµ/, ['ğŸ§']],
    [/è•‰/, ['ğŸŒ']],
    [/æ©™|æ©˜|æŸ‘/, ['ğŸŠ']],
    [/è“/, ['ğŸ“']],
    [/é¢¨|é¢¶|é£„|æ°£|éœ§|ç…™/, ['ğŸ’¨']],
    [/åœŸ|åœ°|ç ‚|çŸ³|å±±|å²©|ç¤¦|ç£š|æ³¥|å¡µ/, ['ğŸª¨']],
    [/é‡‘å±¬|é‡‘|é‹¼|éµ|éŠ…|éŠ€|æ©Ÿ|é½’|æ¢°|è£ç”²|è£å‚™/, ['âš™ï¸']],
    [/é¦¬|é§’/, ['ğŸ']],
    [/ç‰›|çŠ¢/, ['ğŸ‚']],
    [/ç¾Š|ç¾”/, ['ğŸ‘']],
    [/è±¬|è±š/, ['ğŸ–']],
    [/çŠ¬|ç‹—|çµçŠ¬|ç‹¼/, ['ğŸº']],
    [/è²“|ç…|è™|è±¹/, ['ğŸˆ']],
    [/ç†Š/, ['ğŸ»']],
    [/çŒ´|çŒ¿/, ['ğŸ’']],
    [/è™è /, ['ğŸ¦‡']],
    [/å…”/, ['ğŸ‡']],
    [/è±¡|é•·é¼»/, ['ğŸ˜']],
    [/æ™‚é–“|æ™‚|é˜|æ­²|å¤|åŒ–çŸ³|ç´€å…ƒ|ç§’|åˆ†/, ['âŒ›ï¸']],
    [/é¾|ç¸|æ€ª|ç¥/, ['ğŸ‰']],
    [/æ€ªç¸|å·¨æ€ª|å¦–/, ['ğŸ‘¹']],
    [/é³³å‡°|é³³/, ['ğŸ¦â€ğŸ”¥']],
    [/é­š/, ['ğŸŸ']],
    [/é¯Š/, ['ğŸ¦ˆ']],
    [/é¯¨/, ['ğŸ‹']],
    [/æµ·è±š/, ['ğŸ¬']],
    [/ç« é­š/, ['ğŸ™']],
    [/é­·/, ['ğŸ¦‘']],
    [/è¦/, ['ğŸ¦']],
    [/èŸ¹/, ['ğŸ¦€']],
    [/æµ·æ˜Ÿ/, ['â­']],
    [/å·«|æ³•å¸«/, ['ğŸ§™ğŸ»']],
    [/éˆ|é­‚|é­„/, ['ğŸ‘»']],
    [/é­”|å’’|å¹»|è¡“|æ³•|ç¬¦/, ['ğŸª„']],
    [/ç”Ÿ|ç”Ÿå‘½|æ¤ç‰©|è‰|èŠ½|è—¤|è‘‰|è‹—/, ['ğŸŒ±']],
    [/åŠ|åˆ€|åˆƒ|çŸ­åŠ|é•·åŠ|åŒ•é¦–|æ­¦å£«åˆ€|é›™åˆ€|å·¨åŠ/, ['ğŸ—¡ï¸']],
    [/æ–§|æˆ°æ–§|æ‰‹æ–§|é›™åˆƒæ–§/, ['ğŸª“']],
    [/éš|éŒ˜|æˆ°éŒ˜|å¤§éš|æ¦”é ­/, ['ğŸ”¨']],
    [/å¼“|å¼“ç®­|é•·å¼“|çŸ­å¼“|å¼©|åå­—å¼“/, ['ğŸ¹']],
    [/çŸ›|é•·æ§|é•·çŸ›|æ¨™æ§|æˆŸ|æ§åˆƒ/, ['ğŸ—¡ï¸']],
    [/ç›¾|é˜²ç›¾|è­·ç›¾/, ['ğŸ›¡ï¸']],
    [/é£›é¢|æ‰‹è£¡åŠ|æ“²æ–§|æŠ•çŸ³/, ['ğŸ¯']],
    [/æ‰‹æ§|æ­¥æ§|ç‹™æ“Šæ§|çµæ§|éœ°å½ˆæ§|æ§æ¢°/, ['ğŸ”«']],
    [/ç ²|ç‚®|ç«ç ²|å¤§ç ²|åŠ è¾²ç‚®|è¿«æ“Šç ²/, ['ğŸ’£']],
    [/é¬|ç¨¿|é¬å­|åå­—é¬|æŒ–ç¤¦/, ['â›ï¸']],
    [/éŸ|éµé¬|éµéŸ|éŸå­|é¬/, ['ğŸ§¹']], // æ²’éŸå­emojiæš«ç”¨æƒæŠŠ
    [/é‹¸|é‹¸å­/, ['ğŸªš']],
    [/æ‰³æ‰‹|æ¿æ‰‹|å¥—ç­’/, ['ğŸ”§']],
    [/èºçµ²èµ·å­|èµ·å­|èºèµ·/, ['ğŸª›']],
    [/å·¥å…·ç®±|å·¥å…·åŒ…/, ['ğŸ§°']],
  ];
    const emojiPool = ['ğŸª','âœ¨','ğŸ§ª','ğŸ§²','ğŸ§ ','ğŸ²','ğŸ§¯','ğŸ›°ï¸','ğŸª„','ğŸ“¦','ğŸ›¸','ğŸ§°','ğŸ‡','ğŸ”®','ğŸ—¿','ğŸ§Š','ğŸ§±','ğŸŒ‹','ğŸŒªï¸','ğŸŒŠ','ğŸŒŒ','ğŸŒˆ','ğŸªµ','ğŸ','ğŸ¥š','ğŸ°','ğŸ«','â˜‚ï¸','ğŸº','âš—ï¸','ğŸ§µ','ğŸ§·','ğŸ§«','ğŸª¤','ğŸ“¡','ğŸ”§','ğŸ§­'];
function pickEmojiByName(name) {
  if (!name) return [randomFrom(emojiPool)];

  name = String(name).toLowerCase();
  const found = [];
  for (const [re, arr] of rules) {
    if (found.length >= 3) break;
    if (re.test(name)) {
      const emo = Array.isArray(arr) ? arr[0] : arr;
      if (!found.includes(emo)) found.push(emo);
    }
  }
  return found.length ? found : [randomFrom(emojiPool)];
}

// éš¨æ©Ÿä¿åº•
function randomFrom(arr) {
  return arr && arr.length ? arr[Math.floor(Math.random() * arr.length)] : 'â“';
}



function generateName(a,b){
  // semantic-ish naming
  const classify = n => {
    if(/ç«|ç„°|ç†”|ç†±/.test(n)) return 'fire';
    if(/æ°´|æµ·|æ²³|å†°|é›²|é›¨|éœœ/.test(n)) return 'water';
    if(/é¢¨|æ°£|é›²|éœ§|ç…™/.test(n)) return 'wind';
    if(/åœŸ|çŸ³|å±±|å²©|ç¤¦|ç£š|æ³¥/.test(n)) return 'earth';
    if(/é¾|ç¸|é³¥|é­š|èŸ²/.test(n)) return 'creature';
    if(/é‡‘|é‹¼|éµ|æ©Ÿ|é½’|æ¢°/.test(n)) return 'tech';
    return 'other';
  };
  const ca = classify(a), cb = classify(b);
  let name;
  if(a === b){ // åªæœ‰åœ¨å…©å€‹å…ƒç´ å®Œå…¨ç›¸åŒæ™‚ï¼Œæ‰ä½¿ç”¨ã€Œé›™XXã€æ ¼å¼
    const prefix = ca==='creature' ? 'é›™' : 'é›™';
    name = prefix + a;
  } else if((ca==='tech' && cb==='creature') || (cb==='tech' && ca==='creature')){
    name = 'è³½åš' + (ca==='creature'? a : b);
  } else {
    const templates = [
      `${a}${b}`, `${a}ä¹‹${b}`, `${b}-${a}`, `${a} ${b}`, `${a}${b}é«”`, `${a}Â·${b}`
    ];
    name = templates[Math.floor(Math.random()*templates.length)];
  }
  return name
    .replace(/(.)\1\1+/g, '$1$1')
    .replace(/(ç«)ç«/g, 'é›™ç«')
    .replace(/(æ°´)æ°´/g, 'é›™æ°´');
}
 function isApplePlatform() {
  return /Mac|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// ç°¡å–®çš„å¿«å– Mapï¼šemoji -> <img> ç¯€é»
const emojiImgCache = new Map();

function makeCard(name, emojis, your = false) {
  const list = Array.isArray(emojis) ? emojis : (emojis != null ? [emojis] : []);
  const el = document.createElement('div');
  el.className = 'card';
  if (your) el.classList.add('your');
  el.draggable = true;
  el.dataset.name = name;

  const emojiContainer = document.createElement('div');
  emojiContainer.className = 'emoji-container';

  const displayConfig = getElementDisplayConfig(name, your);

  if (displayConfig.showImage && displayConfig.image) {
    createImageElement(emojiContainer, displayConfig.image, name, displayConfig);
  }

  if (displayConfig.showEmoji) {
    const emojiToShow = (list.length > 0) ? list : (displayConfig.emoji || list);

    emojiToShow.forEach(emoji => {
      const emojiEl = document.createElement('div');
      emojiEl.className = 'emoji';
      if (isApplePlatform()) {
        emojiEl.textContent = emoji;
      } else {
        let imgNode;
        if (emojiImgCache.has(emoji)) {
          imgNode = emojiImgCache.get(emoji).cloneNode(true);
        } else {
          const img = document.createElement('img');
          img.src = `https://emojicdn.elk.sh/${encodeURIComponent(emoji)}?style=apple&size=64`;
          img.alt = emoji;
          img.width = 28;
          img.height = 28;
          emojiImgCache.set(emoji, img);
          imgNode = img.cloneNode(true);
        }
        emojiEl.appendChild(imgNode);
      }
      emojiContainer.appendChild(emojiEl);
    });
  }

  el.appendChild(emojiContainer);

  const nameEl = document.createElement('div');
  nameEl.className = 'name';
  nameEl.textContent = name;
  el.appendChild(nameEl);

  add3DTiltEffect(el);
  return el;
}



// 3D å‚¾æ–œè·Ÿéš¨æ•ˆæœå‡½æ•¸
function add3DTiltEffect(cardElement) {
  cardElement.addEventListener('dragstart', () => {
    cardElement.classList.add('dragging');
    cardElement.classList.remove('tilt-active');
  });
  
  cardElement.addEventListener('dragend', () => {
    cardElement.classList.remove('dragging');
  });
  
  cardElement.addEventListener('mouseenter', () => {
    cardElement.classList.add('tilt-active');
  });
  
  cardElement.addEventListener('mouseleave', () => {
    cardElement.classList.remove('tilt-active');
    if (cardElement.matches(':hover')) {
      cardElement.style.transform = 'translateY(-8px) rotateX(15deg) scale(1.05)';
    } else {
      cardElement.style.transform = '';
    }
  });
  
  cardElement.addEventListener('mousemove', (e) => {
    if (!cardElement.classList.contains('tilt-active')) return;
    
    const rect = cardElement.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    const mouseX = e.clientX - centerX;
    const mouseY = e.clientY - centerY;
    
    const tiltX = (mouseY / rect.height) * -15;
    const tiltY = (mouseX / rect.width) * 15;
    
    cardElement.style.transform = `
      translateY(-8px) 
      rotateX(${tiltX}deg) 
      rotateY(${tiltY}deg) 
      scale(1.05)
    `;
  });
}


  


    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(t._h); t._h = setTimeout(()=>t.classList.remove('show'), 1850);
    }

    function spark(x,y,container){
      for(let i=0;i<6;i++){
        const s = document.createElement('div');
        s.className = 'sparkle'; s.textContent = 'âœ¨';
        s.style.left = x + (Math.random()*60-30) + 'px';
        s.style.top  = y + (Math.random()*30-10) + 'px';
        container.appendChild(s);
        setTimeout(()=>s.remove(), 900);
      }
    }
    // éŸ³æ•ˆç®¡ç†ç³»çµ±
class AudioPool {
  constructor() {
    this.pools = new Map();
    this.init();
  }
  
  init() {
    this.createPool('click', 'click.ogg', 3);
    this.createPool('combine', 'newthing.flac', 2);
  }
  
  createPool(name, src, size) {
    const pool = [];
    for(let i = 0; i < size; i++) {
      const audio = new Audio(src);
      audio.volume = 0.5;
      audio.preload = 'auto';
      pool.push(audio);
    }
    this.pools.set(name, pool);
  }
  
  play(name) {
    const pool = this.pools.get(name);
    if (!pool) return;
    
    // æ‰¾åˆ°ç©ºé–’çš„éŸ³æ•ˆå¯¦ä¾‹
    const audio = pool.find(a => a.paused || a.ended || a.currentTime === 0);
    if (audio) {
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }
  }
}

const audioPool = new AudioPool();

function playClick() {
  audioPool.play('click');
}


    // ---------- State ----------
    let state = loadState() || {
      version: SAVE_VERSION,
      known: {},
      unlocked: {},
      history: [],
      missions: []
    };

    // seed base
   for(const [n,e] of firstPool){ state.unlocked[n] = state.unlocked[n] || e; }
    if(!state.missions || state.missions.length===0) regenMissions();
    saveState();

    // ---------- UI Rendering ----------
    const catalogEl = document.getElementById('catalog');
    const bookEl = document.getElementById('book');
    const comboLogEl = document.getElementById('comboLog');
    const workspace = document.getElementById('workspace');
    const dropzone = document.getElementById('dropzone');
    const missionsEl = document.getElementById('missions');
    const progressBar = document.getElementById('progressBar');
    const statsPill = document.getElementById('statsPill');
    const searchEl = document.getElementById('search');
function updateMissionProgress(){
  const total = state.missions.length || 0;
  const done = state.missions.filter(m => m.done).length;
  const pct = total ? Math.round(done / total * 100) : 0;
  progressBar.style.width = pct + '%';
  progressBar.setAttribute('aria-valuenow', pct);
}
    function fuzzyMatch(hay, needle){
      if(!needle) return true;
      const s = hay.toLowerCase();
      const n = needle.toLowerCase().trim();
      if(s.includes(n)) return true;
      let i=0; for(const ch of s){ if(ch===n[i]) i++; if(i===n.length) return true; }
      return false;
    }
    function renderCatalog(filter=''){
  const items = Object.entries(state.unlocked)
    .map(([n,e]) => ({n,e}))
    .filter(x => fuzzyMatch(x.n, filter))
    .sort((a,b) => a.n.localeCompare(b.n,'zh-Hant'));
  
  updateCatalogItems(items);
  
  // stats - ä½¿ç”¨ requestAnimationFrame é¿å…é˜»å¡
  requestAnimationFrame(() => {
    const total = Object.keys(state.unlocked).length;
    statsPill.textContent = `${total} é …`;
  });
}
    function updateCatalogItems(items) {
  const existingCards = new Map();
  

  catalogEl.querySelectorAll('.card').forEach(card => {
    const name = card.dataset.name;
    if (name) existingCards.set(name, card);
  });
  

  const neededCards = new Set(items.map(item => item.n));

  existingCards.forEach((card, name) => {
    if (!neededCards.has(name)) {
      card.remove();
    }
  });
  catalogEl.innerHTML = '';
  const fragment = document.createDocumentFragment();
  
  items.forEach(item => {
    let card = existingCards.get(item.n);
    
    if (!card) {
      card = makeCard(item.n, item.e);
      card.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', JSON.stringify({name: item.n, emoji: item.e}));
      });
    }
    
    fragment.appendChild(card);
  });
  
  catalogEl.appendChild(fragment);
}

    function renderBook(){
      bookEl.innerHTML = '';
      const entries = Object.entries(state.unlocked).sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'));
      const frag = document.createDocumentFragment();
      for(const [n,e] of entries){
        const c = makeCard(n,e);
        c.style.cursor='default'; c.draggable=false;
        frag.appendChild(c);
      }
      bookEl.appendChild(frag);
    }

    function renderHistory(){
      comboLogEl.innerHTML='';
      const frag = document.createDocumentFragment();
      for(const h of state.history.slice(-120).reverse()){
        const row = document.createElement('div');
        row.className='combo';
        row.innerHTML = `
          <div class="mini"><div class="emoji">${h.a.emoji.join('')}</div><div class="name">${h.a.name}</div></div>
          <div>+</div>
          <div class="mini"><div class="emoji">${h.b.emoji.join('')}</div><div class="name">${h.b.name}</div></div>
          <div>=</div>
          <div class="mini"><div class="emoji">${h.res.emoji.join('')}</div><div class="name">${h.res.name}</div></div>
        `;
        frag.appendChild(row);
      }
      comboLogEl.appendChild(frag);
    }


function renderMissions(){
  missionsEl.innerHTML = '';
  for(const m of state.missions){
    const row = document.createElement('div');
    row.className = 'mission';
    row.innerHTML = `<div class="emoji">${m.emoji.join('')}</div><div class="name ${m.done?'done':''}">${m.name}</div>`;
    missionsEl.appendChild(row);
  }
  updateMissionProgress(); 
}
//regen toolset
function getAllElementNames(){
  // ä»¥ã€Œçœ‹å¾—åˆ°çš„å®‡å®™ã€ç‚ºåŸºç¤ï¼šé…æ–¹çµæœ + ç©å®¶å·²ç”¢ç”Ÿéçš„çµæœ
  const set = new Set();

  // é…æ–¹çµæœï¼ˆæ­£å²æ± ï¼‰
  for (const r of Object.values(seedRecipes)) {
    if (Array.isArray(r) && typeof r[0] === 'string') set.add(r[0]);
  }

  for (const k in (state.known || {})) {
    const r = state.known[k];
    if (r && typeof r.name === 'string') set.add(r.name);
  }
  return [...set];
}

function eligibleMissionPool(){
  const unlocked = new Set(Object.keys(state.unlocked || {}));
  const current  = new Set((state.missions || []).map(m => m.name));
  return getAllElementNames().filter(n => !unlocked.has(n) && !current.has(n));
}

function pickEligibleMission(){
  const pool = eligibleMissionPool();
  if (!pool.length) return null;
  return pool[Math.floor(Math.random() * pool.length)];
}




function regenMissions(count = 3, { force = false } = {}) {
  state.missions = Array.isArray(state.missions) ? state.missions : [];
  // force=trueï¼šæ¸…ç©ºï¼›å¦å‰‡åªä¿ç•™æœªå®Œæˆ
  state.missions = force ? [] : state.missions.filter(m => m && !m.done);

  let added = 0;
  while (state.missions.length < count) {
    const next = pickEligibleMission();
    if (!next) break;
    state.missions.push({
      name: next,
      emoji: Array.isArray(state.unlocked[next]) ? state.unlocked[next]
           : (resultEmojiMap[next] || pickEmojiByName(next)),
      done: false
    });
    added++;
  }
  return added;
}




    // ---------- Reset Logic ----------
function hardReset(){
  try {
    localStorage.setItem(LS_KEY, '');
    localStorage.removeItem(LS_KEY);
  } catch {}
  state = {
    version: SAVE_VERSION,
    known: {},
    unlocked: {},
    history: [],
    missions: []
  };
  for (const [n, e] of firstPool) {
    state.unlocked[n] = e;
  }
  regenMissions();
  saveState();
  // æ¸…ç©ºæš«å­˜ UI
  try {
    document.getElementById('workspace').innerHTML = '';
  } catch {}
  renderAll();
  toast('å·²é‡ç½®');
  try { localStorage.removeItem('iec_seen_intro_v2'); } catch {}

  const intro = document.getElementById('intro');
  const textEl = document.getElementById('introText');
  if (intro && textEl) {
    intro.classList.remove('hidden');
    intro.classList.remove('fade');
    textEl.textContent = 'é»æ“Šä»¥é–‹å§‹';

    // è£œæ›ä¸€æ¬¡æ€§çš„é»æ“Šè™•ç†
    const closeIntro = () => {
      try { localStorage.setItem('iec_seen_intro_v2', '1'); } catch {}
      intro.classList.add('fade');
      setTimeout(() => intro.classList.add('hidden'), 750);
    };
    intro.addEventListener('pointerdown', closeIntro, { once: true });
  }
}


    // ---------- Workspace Drag & Combine ----------
    let pending = [];

    dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.borderColor = '#3b82f6'; });
    dropzone.addEventListener('dragleave', ()=>{ dropzone.style.borderColor = '#2a3250'; });

    dropzone.addEventListener('drop', e=>{
      e.preventDefault(); dropzone.style.borderColor = '#2a3250';
      const raw = e.dataTransfer.getData('text/plain');
      const parsed = safeParseJSON(raw);
      if(!parsed.ok || !parsed.val){ toast('æ‹–æ”¾è³‡æ–™æ ¼å¼éŒ¯èª¤'); return; }
      const data = parsed.val;
      if (typeof data.name !== 'string' || !Array.isArray(data.emoji)) {
  toast('æ‹–æ”¾è³‡æ–™ç¼ºå°‘æ¬„ä½'); return;
}

      const rect = workspace.getBoundingClientRect();
      spawnToken(data.name, data.emoji, e.clientX - rect.left, e.clientY - rect.top);
      pending.push(data);
      if(pending.length>=2){
        const [a,b] = pending.splice(0,2);
        combine(a,b,e.clientX - rect.left, e.clientY - rect.top);
      }
    });
    // æ¥µç°¡è£œä¸ï¼šè®“ä¸Ÿåœ¨å¡ç‰‡ä¸Šä¹Ÿæœƒè§¸ç™¼åˆæˆï¼ˆä¿®æ­£ç‰ˆï¼šé¿å…é›™è§¸ç™¼ï¼‰
const board = document.querySelector('.board');

board.addEventListener('dragover', e => {
  if (dropzone.contains(e.target)) return;   // è®“åŸæœ¬ dropzone è‡ªè¡Œè™•ç†
  e.preventDefault();
}, { capture: true });

board.addEventListener('drop', e => {
  if (dropzone.contains(e.target)) return;   // é—œéµï¼šé¿å…è§¸ç™¼å…©æ¬¡
  e.preventDefault();
  dropzone.style.borderColor = '#2a3250';

  const raw = e.dataTransfer.getData('text/plain');
  const parsed = safeParseJSON(raw);
  if (!parsed.ok || !parsed.val) return toast('æ‹–æ”¾è³‡æ–™æ ¼å¼éŒ¯èª¤');
  const { name, emoji } = parsed.val;
  if (typeof name !== 'string' || !Array.isArray(emoji)) return toast('æ‹–æ”¾è³‡æ–™ç¼ºå°‘æ¬„ä½');

  const rect = workspace.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;

  spawnToken(name, emoji, x, y);
  pending.push({ name, emoji });
  if (pending.length >= 2) {
    const [a, b] = pending.splice(0, 2);
    combine(a, b, x, y);
  }
}, { capture: true });


    function spawnToken(name, emoji, x,y){
      const t = document.createElement('div');
      t.className='token'; t.style.left=x+'px'; t.style.top=y+'px';
      t.appendChild(makeCard(name,emoji));
      workspace.appendChild(t);
      return t;
    }

 function combine(a,b,x,y){

  document.querySelectorAll('.token').forEach(el => el.remove());

  if (!Array.isArray(a.emoji)) a.emoji = [a.emoji];
  if (!Array.isArray(b.emoji)) b.emoji = [b.emoji];

  const key = normPair(a.name,b.name);
  let res = state.known[key];
  let isNew = false; let your = false;
  if (!res) {
    const seed = seedMap[key];
    if (seed) {
      const [name, emoji] = seed;
      res = { name, emoji };
    }
  }

  if(!res){
    const name = generateName(a.name,b.name);
    const emoji = pickEmojiByName(name);
    res = {name, emoji};
  }

  // ç´€éŒ„ & è§£é–
  state.known[key] = res;
  if(!state.unlocked[res.name]){ state.unlocked[res.name]=res.emoji; isNew = true; }
  const productToken = spawnToken(
    res.name,
    res.emoji,
    x + (Math.random() * 40 - 20),
    y + (Math.random() * 20 - 10)
  );
  spark(x,y,workspace);
  setTimeout(() => {
  if (productToken) productToken.classList.add('fade-out');
}, 1450);
  setTimeout(() => { if (productToken) productToken.remove(); }, 1700);
  state.history.push({a,b,res});
  if (state.history.length > 35) {
    state.history.splice(0, 10);
  }
for (const m of state.missions) {
  if (!m.done && m.name === res.name) {
    m.done = true;
    toast(`ä»»å‹™å®Œæˆï¼š${m.name} ${m.emoji.join('')}`);
  }
}
// å…¨çµ„å®Œæˆæ‰è‡ªå‹•é‡æ“²
const allDone = state.missions.length > 0 && state.missions.every(m => m.done);
if (allDone) {
  regenMissions();            
}


  saveState();

  renderBook(); renderHistory(); renderCatalog(searchEl.value.trim()); renderMissions();

  audioPool.play('combine');
  toast(isNew? `New Discoverï¼š${res.name} ${res.emoji.join('')}` : `åˆæˆæˆåŠŸï¼š${res.name} ${res.emoji.join('')}`);
}

       

    // ---------- Controls ----------
    function debounce(fn, ms){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), ms); }; }
    searchEl.addEventListener('input', debounce(()=>{ renderCatalog(searchEl.value.trim()); }, 110));
document.getElementById('rerollMissions').addEventListener('click', ()=>{
  const added = regenMissions(3, { force: true }); 
  saveState();
  renderMissions();
  toast(added > 0 ? 'å·²é‡æ“²ä»»å‹™' : 'æ²’æœ‰å¯é‡æ“²çš„ä»»å‹™');
});


    document.getElementById('exportBtn').addEventListener('click', async ()=>{
  playClick();
  
  const result = await SafeFile.export(state);
  if (!result.success) {
    toast('åŒ¯å‡ºå¤±æ•—ï¼š' + result.error);
    return;
  }
  
  const blob = new Blob([JSON.stringify(result.data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = 'wti_safe_save.json'; 
  a.click(); 
  URL.revokeObjectURL(url);
  
  toast(`å·²å®‰å…¨åŒ¯å‡ºå­˜æª”`);
});

    document.getElementById('importBtn').addEventListener('click', ()=>{
  playClick();
  const inp = document.createElement('input'); 
  inp.type = 'file'; 
  inp.accept = 'application/json';
  
  inp.onchange = async ev => {
    const f = ev.target.files[0]; 
    if (!f) return;
    
    const reader = new FileReader(); 
    reader.onload = async () => {
      const parsed = safeParseJSON(reader.result);
      if (!parsed.ok) { 
        toast('è®€å–å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤'); 
        return; 
      }
      
      const result = await SafeFile.import(parsed.val);
      if (!result.success) {
        if (validateState(parsed.val)) {
          state = parsed.val; 
          saveState(); 
          renderAll(); 
          toast('ä»¥ç›¸å®¹æ¨¡å¼åŒ¯å…¥æˆåŠŸ');
        } else {
          toast('åŒ¯å…¥å¤±æ•—ï¼š' + result.reason);
        }
        return;
      }
      
      state = result.data; 
      saveState(); 
      renderAll(); 
      toast(`å®‰å…¨åŒ¯å…¥æˆåŠŸ`);
    }; 
    reader.readAsText(f);
  };
  inp.click();
});


    (function installReset(){
      const resetBtn = document.getElementById('resetBtn');
      let armTimer = null;
      const disarm = () => {
        if(!resetBtn) return;
        resetBtn.dataset.armed = '';
        resetBtn.classList.remove('armed');
        if(resetBtn._oldText) resetBtn.textContent = resetBtn._oldText;
      };
      const arm = () => {
        resetBtn._oldText = resetBtn.textContent;
        resetBtn.dataset.armed = '1';
        resetBtn.classList.add('armed');
        resetBtn.textContent = 'å†æŒ‰ä¸€æ¬¡ç¢ºèªé‡ç½®';
        toast('å†æ¬¡é»æ“Šä»¥ç¢ºèªé‡ç½®');
        clearTimeout(armTimer);
        armTimer = setTimeout(disarm, 3500);
      };
      resetBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        playClick();
        if(!resetBtn.dataset.armed){ arm(); return; }
        clearTimeout(armTimer); disarm(); hardReset();
      });
      resetBtn.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); resetBtn.click(); }
        playClick();
      });
    })();
    function renderAll(){
      renderCatalog(); renderBook(); renderHistory(); renderMissions();
      document.getElementById('ver').textContent = SAVE_VERSION;
    }
    try{ renderAll(); } catch(e){ console.error('render error', e); toast('åˆå§‹åŒ–å¤±æ•—'); }

// --- Opening Cutscene: "Was that Infinite?" ---
(function installOpening(){
  const INTRO_KEY = 'iec_seen_intro_v2';
  // å·²çœ‹éå°±ç•¥éï¼Œç›´æ¥é€²å…¥éŠæˆ²
  try { if (localStorage.getItem(INTRO_KEY)) return; } catch {}

  const intro   = document.getElementById('intro');
  const textEl  = document.getElementById('introText');
  const bgm = document.getElementById('introBgm');
  if(!intro || !textEl) return;
  intro.classList.remove('hidden');
  textEl.textContent = 'é»æ“Šä»¥é–‹å§‹';

  const frames = [
    { t: 'åœ¨å¾ˆä¹…ä»¥å¾Œçš„æŸå¤©ï¼Œä¸€å€‹é«˜ç­‰æ–‡æ˜çš„å¯¦é©—å®¤è£¡ï¼ŒæŸæ¬¡ä¸è©²å¤±æ•—çš„ç¶­åº¦å±•é–‹å¯¦é©—å¤±æ•—äº†ã€‚', hold: 2500 },
    { t: 'æ•´å€‹ä¸‰ç´šç¶­åº¦å®‡å®™è¢«å£“ç¸®ç‚ºç„¡æ•¸çš„ã€Œå…ƒç´ ã€ã€‚', hold: 2500 },
    { t: 'ä½ å’Œé€™é–“ç ´ç¢çš„å¯¦é©—å®¤æ˜¯å”¯ä¸€æ²’è¢«åŒ–ç‚ºå…ƒç´ çš„å¯¦é«”ç‰©è³ªã€‚', hold: 2500 },
    { t: 'ä½ å¿…é ˆä¸æ–·åˆæˆï¼Œé‡æ–°æ‹¼å›ç¶­åº¦èˆ‡å®‡å®™ã€‚', hold: 2500 },
    { t: 'åˆæˆæ©Ÿï¼æ“ä½œä»‹é¢ã€€é€£ç·šä¸­â€¦', hold: 2500 },
    { t: 'è¼‰å…¥åŸºç¤å…ƒç´ â€¦â€¦â€¦è¼‰å…¥å®Œæˆã€‚', hold: 2500 },
    { t: 'æº–å‚™å°±ç·’ã€‚', hold: 2500 },
  ];

  function playBgm(){
    if (!bgm) return;
    bgm.currentTime = 0;
    bgm.volume = 0;

    const fadeIn = () => {
      let v = 0;
      const fade = setInterval(()=>{
        v += 0.05;
        if(v >= 0.4){ v = 0.4; clearInterval(fade); }
        bgm.volume = v;
      }, 120);
    };

    const tryPlay = () => {
      bgm.play().then(fadeIn).catch(() => {
        const once = () => {
          document.removeEventListener('pointerdown', once, {capture:false});
          bgm.play().then(fadeIn).catch(()=>{ /* é‚„ä¸è¡Œå°±ç®—äº† */ });
        };  
        document.addEventListener('pointerdown', once, {once:true});
      });
    };

    tryPlay();
  }

  function stopBgm(){
    if (!bgm) return;
    let v = bgm.volume;
    const fade = setInterval(()=>{
      v -= 0.05;
      if(v <= 0){ v = 0; clearInterval(fade); bgm.pause(); }
      bgm.volume = v;
    }, 120);
  }

  // æ‰“å­—æ©Ÿæ•ˆæœ
  function typeLine(str, speed = 65){
    return new Promise(resolve=>{
      let i = 0, out = '';
      const id = setInterval(()=>{
        out += str[i++];
        textEl.textContent = out;
        if(i >= str.length){
          clearInterval(id);
          resolve();
        }
      }, speed);
    });
  }

  function hideOverlay(){
    intro.classList.add('fade');
    setTimeout(()=> intro.classList.add('hidden'), 750);
  }

  // åŸ·è¡Œé–‹å ´å‹•ç•«
  async function run(){
    textEl.textContent = '';
    
    playBgm();   

    for(const f of frames){
      await typeLine(f.t);
      await new Promise(r=> setTimeout(r, f.hold||800));
      textEl.textContent = textEl.textContent + '\n';
    }

    // æ¨™è¨˜å·²çœ‹éï¼Œéš±è—é–‹å ´
    try { localStorage.setItem(INTRO_KEY, '1'); } catch {}
    hideOverlay();
    stopBgm();
  }
  intro.addEventListener('pointerdown', ()=>{
    run();
  }, {once:true});

})();

  </script>
</body>
</html>
