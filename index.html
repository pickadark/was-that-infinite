<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Was that Infinite? — Local Prototype</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#141823; --card:#1a2030; --muted:#9aa0a6; --fg:#e9eef5; --accent:#6dd5fa; --accent2:#7f53ac;
      --good:#19c37d; --warn:#ffb020; --bad:#ff5d5d; --glow:0 0 0 1px rgba(255,255,255,.06),0 10px 30px rgba(0,0,0,.45);
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 1200px at 0% 0%,#121726 0%,#0f1115 50%,#0b0d12 100%);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    .app{display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:auto 1fr auto;grid-template-areas:
      'header header header'
      'left main right'
      'footer footer footer';height:100vh}

    header{grid-area:header;display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #202637;background:#0e1320;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;letter-spacing:.3px;font-weight:700}
    header .actions{margin-left:auto;display:flex;gap:8px}
    button, .btn{background:linear-gradient(135deg,rgba(125,146,255,.12),rgba(125,146,255,.05));border:1px solid #2b3350;color:var(--fg);padding:8px 10px;border-radius:12px;cursor:pointer;box-shadow:var(--glow);transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:#111726;border:1px solid #28304a;color:var(--muted)}

    .left{grid-area:left;background:var(--panel);border-right:1px solid #22283d;display:flex;flex-direction:column;min-height:0}
    .left .search{padding:10px;display:flex;gap:8px;align-items:center}
    .left input{flex:1;width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3350;background:#0f1422;color:var(--fg)}
    .catalog{padding:8px 10px;overflow:auto;display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .card{user-select:none;background:linear-gradient(180deg,#1b2233,#151b29);border:1px solid #2a3250;border-radius:14px;padding:10px;display:flex;flex-direction:column;align-items:center;gap:6px;box-shadow:var(--glow);cursor:grab}
    .card.rare{outline:2px solid #b78cff; box-shadow:0 0 12px rgba(183,140,255,.45), var(--glow)}
    .card:active{cursor:grabbing}
    .emoji{font-size:28px}
    .name{font-size:12px;color:#c7d0dd;text-align:center}

    .main{grid-area:main;position:relative;display:grid;grid-template-rows:1fr 220px}
    .board{position:relative;overflow:hidden}
    .dropzone{position:absolute;inset:0;display:grid;place-items:center;border:2px dashed #2a3250;border-radius:16px;margin:16px;background:linear-gradient(180deg,rgba(109,213,250,.08),rgba(127,83,172,.08))}
    .dropzone .hint{opacity:.8;color:var(--muted)}

    .workspace{position:absolute;inset:0;margin:16px;border-radius:16px;pointer-events:none}
    .token{position:absolute;pointer-events:auto;transform:translate(-50%,-50%);}
    .token .card{padding:8px 10px}

    .combos{border-top:1px solid #22283d;background:#0e1423;overflow:auto}
    .combos h3{margin:10px 14px;font-size:13px;color:#aab4c8}
    .combo-log{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;padding:10px}
    .combo{background:#131a2b;border:1px solid #26304e;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .combo .mini{display:flex;align-items:center;gap:6px}
    .mini .emoji{font-size:18px}

    .right{grid-area:right;background:var(--panel);border-left:1px solid #22283d;display:flex;flex-direction:column;min-height:0}
    .right h3{margin:10px 14px;font-size:13px;color:#aab4c8}
    .book{padding:10px;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
    .panel{border-top:1px solid #22283d;background:#0e1423;padding:10px 12px;display:grid;gap:8px}
    .progress{height:8px;background:#0c1220;border:1px solid #26304e;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#6dd5fa,#7f53ac)}
    .missions{display:grid;gap:6px}
    .mission{display:flex;align-items:center;gap:8px;background:#11182a;border:1px solid #22304c;padding:6px 8px;border-radius:10px}
    .mission .done{opacity:.5;text-decoration:line-through}

    footer{grid-area:footer;border-top:1px solid #22283d;background:#0e1320;color:var(--muted);padding:8px 12px;display:flex;align-items:center;gap:10px}

    .toast{position:fixed;right:16px;bottom:16px;background:#0e1423;border:1px solid #2a3352;color:#eaf2ff;padding:10px 12px;border-radius:12px;box-shadow:var(--glow);opacity:0;transform:translateY(8px);transition:all .25s ease;z-index:99}
    .toast.show{opacity:1;transform:translateY(0)}
    .sparkle{position:absolute;font-size:18px;pointer-events:none;animation:spark .8s ease forwards}
    @keyframes spark{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}40%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-70%) scale(.3)}}
    .emoji-container {
  display: flex;
  justify-content: center; /* 水平居中 */
  align-items: center;     /* 垂直居中 */
  gap: 4px;               /* emoji 之間的間距 */
}
.token { transition: opacity 0.25s ease; }
.token.fade-out { opacity: 0; }


.emoji {
  font-size: 28px;
}
    /* tiny test panel */
    #testPanel{position:fixed;left:10px;bottom:10px;max-width:44ch;background:#0e1423;border:1px solid #2a3352;color:#cfe2ff;padding:8px 10px;border-radius:10px;box-shadow:var(--glow);font-size:12px;opacity:.9}
    #testPanel summary{cursor:pointer;color:#9cc0ff}
      /* armed reset visual */
    #resetBtn.armed{ border-color:#ff4d4f !important; background:linear-gradient(135deg, rgba(255,77,79,.18), rgba(255,77,79,.08)); color:#ffecec }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Was that Infinite? <span class="pill">Local Prototype</span></h1>
      <div class="actions">
        <button id="exportBtn" title="匯出資料">匯出</button>
        <button id="importBtn" title="匯入資料">匯入</button>
        <button id="resetBtn" title="重置所有進度" style="border-color:#4a2030">重置</button>
      </div>
    </header>

    <aside class="left">
      <div class="search">
        <input id="search" placeholder="搜尋基礎元素或已解鎖物品" />
        <span class="pill" id="statsPill">—</span>
      </div>
      <div id="catalog" class="catalog"></div>
    </aside>

    <main class="main">
      <section class="board">
        <div class="dropzone" id="dropzone"><div class="hint">把兩個卡片拖進來合成</div></div>
        <div class="workspace" id="workspace"></div>
      </section>
      <section class="combos">
        <h3>合成紀錄</h3>
        <div id="comboLog" class="combo-log"></div>
      </section>
    </main>

    <aside class="right">
      <h3>收集冊</h3>
      <div id="book" class="book"></div>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong style="font-size:13px;color:#cfe2ff">進度</strong>
          <button id="rerollMissions" class="btn" style="padding:6px 8px;font-size:12px">重擲任務</button>
        </div>
        <div class="progress"><div id="progressBar" class="bar" style="width:0%"></div></div>
        <div class="missions" id="missions"></div>
      </div>
    </aside>

    <footer>
      <span>本地儲存 v<span id="ver"></span> • 無後端 • 支援 new discover</span>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Versioning ----------
    const SAVE_VERSION = 2;

    // ---------- Robust JSON helpers ----------
    function safeParseJSON(raw){
      try{
        if(raw == null) return {ok:true, val:null};
        if(typeof raw !== 'string') return {ok:false, err:'not-string'};
        const s = raw.trim();
        if(s === '' || s === 'null' || s === 'undefined') return {ok:true, val:null};
        return {ok:true, val: JSON.parse(s)};
      }catch(err){ return {ok:false, err}; }
    }

    function isPlainObject(o){ return Object.prototype.toString.call(o) === '[object Object]'; }

    function validateState(s){
      if(!s) return false;
      if(!isPlainObject(s.known) || !isPlainObject(s.unlocked) || !Array.isArray(s.history)) return false;
      if(!('version' in s)) s.version = 1; // migrate older saves
      if(!Array.isArray(s.missions)) s.missions = [];
      return true;
    }

    // ---------- Persistence Layer ----------
    const LS_KEY = 'iec_save_v1';
    function saveState(){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      catch(e){ console.warn('saveState failed', e); toast('儲存失敗：配額或瀏覽器限制'); }
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const parsed = safeParseJSON(raw);
        if(!parsed.ok){ console.warn('loadState: corrupted raw', parsed.err); return null; }
        const val = parsed.val;
        if(!validateState(val)) return null;
        // migrate
        if(val.version < SAVE_VERSION){ val.version = SAVE_VERSION; }
        return val;
      }catch(e){
        console.warn('loadState: exception, wipe bad save', e);
        try{ localStorage.removeItem(LS_KEY); }catch{ /* ignore */ }
        return null;
      }
    }

    // ---------- Data ----------
const firstPool = [
  ['水',['💧']], ['火',['🔥']], ['土',['🟫']], ['風',['💨']]
];
const seedRecipes = {
  '水+土':['泥',['🟤']],
  '河+石頭':['沙',['🏜️']],
  '海+樹':['珊瑚',['🪸']],
  '熔爐+雜金屬':['純金屬',['⚙️']],
  '水+泥':['泥漿',['🟤','💧']],
  '水+沙':['泥漿',['🟤','💧']],
  '風+沙':['沙塵暴',['💨','🪨']],
  '火+煙':['灰燼',['🔥','🌫️']],  
  '灰燼+土':['沃壤',['🟫','✨']],
  '沃壤+植物':['作物',['🌾']],
  '水+水':['河',['💧','🌊']],
  '河+河':['湖',['💧','🏞️']],
  '湖+湖':['海',['🌊']],
  '泥+光':['細胞',['🦠']],
  '細胞+細胞':['生命',['🌱']],
  '雜金屬+風':['電',['⚡']],
  '火+土':['磚',['🧱']],
  '火+泥':['黏土',['🟤','🪨']],
  '火+黏土':['水泥',['🧱','🪨']],
  '火+水':['蒸氣',['💨']],
  '土+土':['石頭',['🪨']],
  '石頭+火':['雜金屬',['⚙️']],
  '風+火':['煙',['🌫️']],
  '風+水':['雲',['☁️']],
  '雲+風':['天空',['🌈']],
  '雲+電':['雷',['🌩️']],
  '風+雨':['暴雨',['⛈️']],
  '雲+水':['雨',['🌧️']],
  '天空+火':['太陽',['☀️']],
  '天空+電':['光',['✨']],
  '天空+光':['月球',['🌕']],
  '太陽+月球':['時間',['⌛️']],
  '生命+土':['植物',['🌿']],
  '植物+時間':['樹',['🌳']],
  '電+水': ['電解水',['⚡','💧']],
  '植物+雨':['花朵',['🌸']],
  '植物+水':['水生植物',['💧','🌿']],
  '雜金屬+電':['低階機器',['🤖']],
  '純金屬+電':['高階機器',['🤖']],
  '水+時間':['冰',['🧊']],
  '水+冰':['雪',['❄️']],
  '火+雜金屬':['熔爐',['🔥','🏭']],
  '生命+水':['魚',['🐟']],
  '魚+電':['電鰻',['🐟','⚡']],
  '土+時間':['化石',['🦴']],
  '生命+純金屬':['賽博',['🧬','🤖']]
};

// 在 seedRecipes 後面加
const normPair = (a,b) => [a,b].sort().join('+');
const seedMap = {};
for (const [k, v] of Object.entries(seedRecipes)) {
  const [a, b] = k.split('+');
  seedMap[normPair(a, b)] = v; // v 形如 ['泥',['🟤']]
}
const resultEmojiMap = {};
for (const [k, v] of Object.entries(seedRecipes)) {
  const [name, emoji] = v;                 // v 形如 ['泥', ['🟤']]
  resultEmojiMap[name] = Array.isArray(emoji) ? emoji : [emoji];
}
      const rules = [
    [/黑洞|宇宙|銀河|星系|行星|恆星|星|彗星/, ['🪐']],
    [/水|泉|雨|滴/, ['💧']],
    [/海|潮|浪|洋/, ['🌊']],
    [/河|湖/, ['🏞️']],             
    [/樹|林|木|森|松|柏/, ['🌲']],
    [/花|瓣|櫻|梅|菊|蓮|蘭/, ['🌸']],
    [/蟲|幼蟲/, ['🐛']],
    [/蝶/, ['🦋']],
    [/甲蟲|鍬形蟲|金龜子/, ['🪲']],
    [/蜂/, ['🐝']],
    [/螞蟻|蟻/, ['🐜']],
    [/蚊/, ['🦟']],
    [/瓢蟲/, ['🐞']],
    [/磁|磁鐵|磁場/, ['🧲']],
    [/冰|結冰/, ['🧊']],
    [/雪|霜|寒/, ['❄️']], 
    [/火|炎|焰|熔|熱|熾|燄/, ['🔥']],
    [/電|雷|閃電|電擊/, ['⚡']],
    [/果|蘋果/, ['🍎']],
    [/葡萄/, ['🍇']],
    [/鳥|鷹|隼/, ['🦅']],
    [/鴨|鵝|雁/, ['🦆']],
    [/蛇|蟒/, ['🐍']],
    [/龜|海龜/, ['🐢']],
    [/蜥|蜥蜴/, ['🦎']],
    [/蛙|青蛙|蟾蜍/, ['🐸']],
    [/鶴/, ['🐦']],
    [/鴿/, ['🕊️']],
    [/雞|雛/, ['🐔']],
    [/孔雀/, ['🦚']],
    [/企鵝/, ['🐧']],
    [/蕉/, ['🍌']],
    [/橙|橘|柑/, ['🍊']],
    [/莓/, ['🍓']],
    [/風|颶|飄|氣|霧|煙/, ['💨']],
    [/土|地|砂|石|山|岩|礦|磚|泥|塵/, ['🪨']],
    [/金屬|金|鋼|鐵|銅|銀|機|齒|械|裝甲|裝備/, ['⚙️']],
    [/馬|駒/, ['🐎']],
    [/牛|犢/, ['🐂']],
    [/羊|羔/, ['🐑']],
    [/豬|豚/, ['🐖']],
    [/犬|狗|獵犬|狼/, ['🐺']],
    [/貓|獅|虎|豹/, ['🐈']],
    [/熊/, ['🐻']],
    [/猴|猿/, ['🐒']],
    [/蝙蝠/, ['🦇']],
    [/兔/, ['🐇']],
    [/象|長鼻/, ['🐘']],
    [/時間|時|鐘|歲|古|化石|紀元|秒|分/, ['⌛️']],
    [/龍|獸|怪|神/, ['🐉']],
    [/怪獸|巨怪|妖/, ['👹']],
    [/鳳凰|鳳/, ['🐦‍🔥']],
    [/魚/, ['🐟']],
    [/鯊/, ['🦈']],
    [/鯨/, ['🐋']],
    [/海豚/, ['🐬']],
    [/章魚/, ['🐙']],
    [/魷/, ['🦑']],
    [/蝦/, ['🦐']],
    [/蟹/, ['🦀']],
    [/海星/, ['⭐']],
    [/巫|法師/, ['🧙🏻']],
    [/靈|魂|魄/, ['👻']],
    [/魔|咒|幻|術|法|符/, ['🪄']],
    [/生|生命|植物|草|芽|藤|葉|苗/, ['🌱']],
    [/劍|刀|刃|短劍|長劍|匕首|武士刀|雙刀|巨劍/, ['🗡️']],
    [/斧|戰斧|手斧|雙刃斧/, ['🪓']],
    [/鎚|錘|戰錘|大鎚|榔頭/, ['🔨']],
    [/弓|弓箭|長弓|短弓|弩|十字弓/, ['🏹']],
    [/矛|長槍|長矛|標槍|戟|槍刃/, ['🗡️']],
    [/盾|防盾|護盾/, ['🛡️']],
    [/飛鏢|手裡劍|擲斧|投石/, ['🎯']],
    [/手槍|步槍|狙擊槍|獵槍|霰彈槍|槍械/, ['🔫']],
    [/砲|炮|火砲|大砲|加農炮|迫擊砲/, ['💣']],
    [/鎬|稿|鎬子|十字鎬|挖礦/, ['⛏️']],
    [/鏟|鐵鍬|鐵鏟|鏟子|鍬/, ['🧹']], // 沒鏟子emoji暫用掃把
    [/鋸|鋸子/, ['🪚']],
    [/扳手|板手|套筒|梅花扳手/, ['🔧']],
    [/螺絲起子|起子|螺起/, ['🪛']],
    [/工具箱|工具包/, ['🧰']],
  ];
    const emojiPool = ['🪐','✨','🧪','🧲','🧠','🎲','🧯','🛰️','🪄','📦','🛸','🧰','🎇','🔮','🗿','🧊','🧱','🌋','🌪️','🌊','🌌','🌈','🪵','🍞','🥚','🍰','🍫','☂️','🎺','⚗️','🧵','🧷','🧫','🪤','📡','🔧','🧭'];
function pickEmojiByName(name) {
  if (!name) return [randomFrom(emojiPool)];

  name = String(name).toLowerCase();
  const found = [];
  for (const [re, arr] of rules) {
    if (found.length >= 3) break;
    if (re.test(name)) {
      const emo = Array.isArray(arr) ? arr[0] : arr;
      if (!found.includes(emo)) found.push(emo);
    }
  }
  return found.length ? found : [randomFrom(emojiPool)];
}

// 隨機保底
function randomFrom(arr) {
  return arr && arr.length ? arr[Math.floor(Math.random() * arr.length)] : '❓';
}



function generateName(a,b){
  // semantic-ish naming
  const classify = n => {
    if(/火|焰|熔|熱/.test(n)) return 'fire';
    if(/水|海|河|冰|雲|雨|霜/.test(n)) return 'water';
    if(/風|氣|雲|霧|煙/.test(n)) return 'wind';
    if(/土|石|山|岩|礦|磚|泥/.test(n)) return 'earth';
    if(/龍|獸|鳥|魚|蟲/.test(n)) return 'creature';
    if(/金|鋼|鐵|機|齒|械/.test(n)) return 'tech';
    return 'other';
  };
  const ca = classify(a), cb = classify(b);
  let name;
  if(a === b){ // 只有在兩個元素完全相同時，才使用「雙XX」格式
    const prefix = ca==='creature' ? '雙' : '雙';
    name = prefix + a;
  } else if((ca==='tech' && cb==='creature') || (cb==='tech' && ca==='creature')){
    name = '賽博' + (ca==='creature'? a : b);
  } else {
    const templates = [
      `${a}${b}`, `${a}之${b}`, `${b}-${a}`, `${a} ${b}`, `${a}${b}體`, `${a}·${b}`
    ];
    name = templates[Math.floor(Math.random()*templates.length)];
  }
  return name
    .replace(/(.)\1\1+/g, '$1$1')
    .replace(/(火)火/g, '雙火')
    .replace(/(水)水/g, '雙水');
}
 function isApplePlatform() {
  return /Mac|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// 簡單的快取 Map：emoji -> <img> 節點
const emojiImgCache = new Map();

function makeCard(name, emojis, rare = false) {
  const list = Array.isArray(emojis) ? emojis : [emojis];
  const el = document.createElement('div');
  el.className = 'card'
  el.draggable = true;
  el.dataset.name = name;

  const emojiContainer = document.createElement('div');
  emojiContainer.className = 'emoji-container';

  list.forEach(emoji => {
    const emojiEl = document.createElement('div');
    emojiEl.className = 'emoji';

    if (isApplePlatform()) {
      // 蘋果平台直接用文字 emoji
      emojiEl.textContent = emoji;
    } else {
      // 其他平台用快取的蘋果風格圖片
      let imgNode;
      if (emojiImgCache.has(emoji)) {
        // 從快取複製節點
        imgNode = emojiImgCache.get(emoji).cloneNode(true);
      } else {
        // 新建圖片並存到快取
        const img = document.createElement('img');
        img.src = `https://emojicdn.elk.sh/${encodeURIComponent(emoji)}?style=apple&size=64`;
        img.alt = emoji;
        img.width = 28;
        img.height = 28;
        emojiImgCache.set(emoji, img);
        imgNode = img.cloneNode(true);
      }
      emojiEl.appendChild(imgNode);
    }

    emojiContainer.appendChild(emojiEl);
  });

  el.appendChild(emojiContainer);

  const nameEl = document.createElement('div');
  nameEl.className = 'name';
  nameEl.textContent = name;
  el.appendChild(nameEl);

  return el;
}


  


    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(t._h); t._h = setTimeout(()=>t.classList.remove('show'), 1850);
    }

    function spark(x,y,container){
      for(let i=0;i<6;i++){
        const s = document.createElement('div');
        s.className = 'sparkle'; s.textContent = '✨';
        s.style.left = x + (Math.random()*60-30) + 'px';
        s.style.top  = y + (Math.random()*30-10) + 'px';
        container.appendChild(s);
        setTimeout(()=>s.remove(), 900);
      }
    }
    function playClick(){
  try {
    const audio = new Audio('click.ogg');
    audio.play().catch(err => console.warn('click 音效播放被阻擋', err));
  } catch (err) {
    console.warn('播放 click.ogg 失敗', err);
  }
}


    // ---------- State ----------
    let state = loadState() || {
      version: SAVE_VERSION,
      known: {},
      unlocked: {},
      history: [],
      missions: []
    };

    // seed base
   for(const [n,e] of firstPool){ state.unlocked[n] = state.unlocked[n] || e; }
    if(!state.missions || state.missions.length===0) regenMissions();
    saveState();

    // ---------- UI Rendering ----------
    const catalogEl = document.getElementById('catalog');
    const bookEl = document.getElementById('book');
    const comboLogEl = document.getElementById('comboLog');
    const workspace = document.getElementById('workspace');
    const dropzone = document.getElementById('dropzone');
    const missionsEl = document.getElementById('missions');
    const progressBar = document.getElementById('progressBar');
    const statsPill = document.getElementById('statsPill');
    const searchEl = document.getElementById('search');
function updateMissionProgress(){
  const total = state.missions.length || 0;
  const done = state.missions.filter(m => m.done).length;
  const pct = total ? Math.round(done / total * 100) : 0;
  progressBar.style.width = pct + '%';
  progressBar.setAttribute('aria-valuenow', pct);
}
    function fuzzyMatch(hay, needle){
      if(!needle) return true;
      const s = hay.toLowerCase();
      const n = needle.toLowerCase().trim();
      if(s.includes(n)) return true;
      // simple subsequence fuzzy: all chars appear in order
      let i=0; for(const ch of s){ if(ch===n[i]) i++; if(i===n.length) return true; }
      return false;
    }

    function renderCatalog(filter=''){
      catalogEl.innerHTML = '';
      const items = Object.entries(state.unlocked).map(([n,e])=>({n,e}))
        .filter(x=>fuzzyMatch(x.n, filter))
        .sort((a,b)=>a.n.localeCompare(b.n,'zh-Hant'));
      const frag = document.createDocumentFragment();
      for(const it of items){
        const c = makeCard(it.n,it.e);
        c.addEventListener('dragstart', ev=>{
          ev.dataTransfer.setData('text/plain', JSON.stringify({name:it.n, emoji:it.e}));
        });
        frag.appendChild(c);
      }
      catalogEl.appendChild(frag);
      // stats
      const total = Object.keys(state.unlocked).length;
      statsPill.textContent = `${total} 項`;
    }

    function renderBook(){
      bookEl.innerHTML = '';
      const entries = Object.entries(state.unlocked).sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'));
      const frag = document.createDocumentFragment();
      for(const [n,e] of entries){
        const c = makeCard(n,e);
        c.style.cursor='default'; c.draggable=false;
        frag.appendChild(c);
      }
      bookEl.appendChild(frag);
    }

    function renderHistory(){
      comboLogEl.innerHTML='';
      const frag = document.createDocumentFragment();
      for(const h of state.history.slice(-120).reverse()){
        const row = document.createElement('div');
        row.className='combo';
        row.innerHTML = `
          <div class="mini"><div class="emoji">${h.a.emoji.join('')}</div><div class="name">${h.a.name}</div></div>
          <div>+</div>
          <div class="mini"><div class="emoji">${h.b.emoji.join('')}</div><div class="name">${h.b.name}</div></div>
          <div>=</div>
          <div class="mini"><div class="emoji">${h.res.emoji.join('')}</div><div class="name">${h.res.name}</div></div>
        `;
        frag.appendChild(row);
      }
      comboLogEl.appendChild(frag);
    }

// 2) 替換 renderMissions()，結尾呼叫任務進度更新
function renderMissions(){
  missionsEl.innerHTML = '';
  for(const m of state.missions){
    const row = document.createElement('div');
    row.className = 'mission';
    row.innerHTML = `<div class="emoji">${m.emoji.join('')}</div><div class="name ${m.done?'done':''}">${m.name}</div>`;
    missionsEl.appendChild(row);
  }
  updateMissionProgress(); 
}
//regen toolset
function getAllElementNames(){
  // 以「看得到的宇宙」為基礎：配方結果 + 玩家已產生過的結果
  const set = new Set();

  // 配方結果（正史池）
  for (const r of Object.values(seedRecipes)) {
    if (Array.isArray(r) && typeof r[0] === 'string') set.add(r[0]);
  }
  // 玩家曾經產生過（包含 new discover）
  for (const k in (state.known || {})) {
    const r = state.known[k];
    if (r && typeof r.name === 'string') set.add(r.name);
  }
  return [...set];
}

function eligibleMissionPool(){
  const unlocked = new Set(Object.keys(state.unlocked || {}));
  const current  = new Set((state.missions || []).map(m => m.name));
  return getAllElementNames().filter(n => !unlocked.has(n) && !current.has(n));
}

function pickEligibleMission(){
  const pool = eligibleMissionPool();
  if (!pool.length) return null;
  return pool[Math.floor(Math.random() * pool.length)];
}



// 替換原本的 regenMissions()
 // === REPLACE: regenMissions() ===
function regenMissions(count = 3){
  state.missions = Array.isArray(state.missions) ? state.missions : [];

  // 先保留尚未完成的
  state.missions = state.missions.filter(m => m && !m.done);

  // 補到指定數量，來源只挑「尚未獲得、且不重複現有任務」
  while (state.missions.length < count) {
    const next = pickEligibleMission();
    if (!next) break; // 沒東西可補就停
    state.missions.push({
      name: next,
      emoji: Array.isArray(state.unlocked[next]) ? state.unlocked[next]
           : (resultEmojiMap[next] || pickEmojiByName(next)),
      done: false
    });
  }
}




    // ---------- Reset Logic ----------
function hardReset(){
  try {
    localStorage.setItem(LS_KEY, '');
    localStorage.removeItem(LS_KEY);
  } catch {}
  state = {
    version: SAVE_VERSION,
    known: {},
    unlocked: {},
    history: [],
    missions: []
  };
  // 只保留初始基礎元素
  for (const [n, e] of firstPool) {
    state.unlocked[n] = e;
  }
  regenMissions();
  saveState();
  // 清空暫存 UI
  try {
    document.getElementById('workspace').innerHTML = '';
  } catch {}
  renderAll();
  toast('已重置');
}


    // ---------- Workspace Drag & Combine ----------
    let pending = [];

    dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.borderColor = '#3b82f6'; });
    dropzone.addEventListener('dragleave', ()=>{ dropzone.style.borderColor = '#2a3250'; });

    dropzone.addEventListener('drop', e=>{
      e.preventDefault(); dropzone.style.borderColor = '#2a3250';
      const raw = e.dataTransfer.getData('text/plain');
      const parsed = safeParseJSON(raw);
      if(!parsed.ok || !parsed.val){ toast('拖放資料格式錯誤'); return; }
      const data = parsed.val;
      if (typeof data.name !== 'string' || !Array.isArray(data.emoji)) {
  toast('拖放資料缺少欄位'); return;
}

      const rect = workspace.getBoundingClientRect();
      spawnToken(data.name, data.emoji, e.clientX - rect.left, e.clientY - rect.top);
      pending.push(data);
      if(pending.length>=2){
        const [a,b] = pending.splice(0,2);
        combine(a,b,e.clientX - rect.left, e.clientY - rect.top);
      }
    });

    function spawnToken(name, emoji, x,y){
      const t = document.createElement('div');
      t.className='token'; t.style.left=x+'px'; t.style.top=y+'px';
      t.appendChild(makeCard(name,emoji));
      workspace.appendChild(t);
      return t;
    }

 function combine(a,b,x,y){

  document.querySelectorAll('.token').forEach(el => el.remove());

  if (!Array.isArray(a.emoji)) a.emoji = [a.emoji];
  if (!Array.isArray(b.emoji)) b.emoji = [b.emoji];

  const key = normPair(a.name,b.name);
  let res = state.known[key];
  let isNew = false; let rare = false;

  // ← 新增：優先吃 seed 配方
  if (!res) {
    const seed = seedMap[key];
    if (seed) {
      const [name, emoji] = seed;
      res = { name, emoji };
    }
  }

  if(!res){
    const name = generateName(a.name,b.name);
    const emoji = pickEmojiByName(name);
    res = {name, emoji};
  }

  // 紀錄 & 解鎖
  state.known[key] = res;
  if(!state.unlocked[res.name]){ state.unlocked[res.name]=res.emoji; isNew = true; }
  rare = Math.random()<0.06;
  const productToken = spawnToken(
    res.name,
    res.emoji,
    x + (Math.random() * 40 - 20),
    y + (Math.random() * 20 - 10)
  );
  spark(x,y,workspace);
  setTimeout(() => {
  if (productToken) productToken.classList.add('fade-out');
}, 1450);
  setTimeout(() => { if (productToken) productToken.remove(); }, 1700);
  state.history.push({a,b,res});
for (const m of state.missions) {
  if (!m.done && m.name === res.name) {
    m.done = true;
    toast(`任務完成：${m.name} ${m.emoji.join('')}`);
  }
}
// 全組完成才自動重擲
const allDone = state.missions.length > 0 && state.missions.every(m => m.done);
if (allDone) {
  regenMissions();              // 重新抽一整組（預設 3 個）
}


  saveState();

  renderBook(); renderHistory(); renderCatalog(searchEl.value.trim()); renderMissions();

    try {
    const audio = new Audio('newthing.flac');
    audio.play().catch(err => console.warn('音效播放被阻擋', err));
  } catch (err) {
    console.warn('播放 newthing.flac 失敗', err);
  }
  toast(isNew? `New Discover：${res.name} ${res.emoji.join('')}` : `合成成功：${res.name} ${res.emoji.join('')}`);
}

       

    // ---------- Controls ----------
    function debounce(fn, ms){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), ms); }; }
    searchEl.addEventListener('input', debounce(()=>{ renderCatalog(searchEl.value.trim()); }, 80));

    document.getElementById('rerollMissions').addEventListener('click', ()=>{ regenMissions(); saveState(); renderMissions(); toast('已重擲任務'); });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      playClick();
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='iec_save.json'; a.click(); URL.revokeObjectURL(url);
      toast('已匯出存檔');
    });

    document.getElementById('importBtn').addEventListener('click', ()=>{
      playClick();
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = ev => {
        const f = ev.target.files[0]; if(!f) return;
        const reader = new FileReader(); reader.onload = () => {
          const parsed = safeParseJSON(reader.result);
          if(!parsed.ok){ toast('讀取失敗：JSON 格式錯誤'); return; }
          const obj = parsed.val;
          if(validateState(obj)){ state = obj; saveState(); renderAll(); toast('匯入成功'); }
          else toast('格式錯誤或缺少必要欄位');
        }; reader.readAsText(f);
      };
      inp.click();
    });

    // safer two-tap confirm (some sandboxes block window.confirm)
    (function installReset(){
      const resetBtn = document.getElementById('resetBtn');
      let armTimer = null;
      const disarm = () => {
        if(!resetBtn) return;
        resetBtn.dataset.armed = '';
        resetBtn.classList.remove('armed');
        if(resetBtn._oldText) resetBtn.textContent = resetBtn._oldText;
      };
      const arm = () => {
        resetBtn._oldText = resetBtn.textContent;
        resetBtn.dataset.armed = '1';
        resetBtn.classList.add('armed');
        resetBtn.textContent = '再按一次確認重置';
        toast('再次點擊以確認重置');
        clearTimeout(armTimer);
        armTimer = setTimeout(disarm, 3500);
      };
      resetBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        playClick();
        if(!resetBtn.dataset.armed){ arm(); return; }
        clearTimeout(armTimer); disarm(); hardReset();
      });
      // keyboard friendly
      resetBtn.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); resetBtn.click(); }
        playClick();
      });
    })();
    function renderAll(){
      renderCatalog(); renderBook(); renderHistory(); renderMissions();
      document.getElementById('ver').textContent = SAVE_VERSION;
    }
    try{ renderAll(); } catch(e){ console.error('render error', e); toast('初始化失敗'); }
  </script>
</body>
</html>
