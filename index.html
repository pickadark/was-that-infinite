<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Was that Infinite? ‚Äî Local Prototype</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#141823; --card:#1a2030; --muted:#9aa0a6; --fg:#e9eef5; --accent:#6dd5fa; --accent2:#7f53ac;
      --good:#19c37d; --warn:#ffb020; --bad:#ff5d5d; --glow:0 0 0 1px rgba(255,255,255,.06),0 10px 30px rgba(0,0,0,.45);
      --cursor-normal: url("X-cursor.png") 8 8, auto;   
      --cursor-drag:   url("X-cursor-drag.png") 10 10, grabbing;
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 1200px at 0% 0%,#121726 0%,#0f1115 50%,#0b0d12 100%);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif; cursor: var(--cursor-normal);}

    .app{display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:auto 1fr auto;grid-template-areas:
      'header header header'
      'left main right'
      'footer footer footer';height:100vh}

    header{grid-area:header;display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #202637;background:#0e1320;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;letter-spacing:.3px;font-weight:700}
    header .actions{margin-left:auto;display:flex;gap:8px}
    button, .btn{background:linear-gradient(135deg,rgba(125,146,255,.12),rgba(125,146,255,.05));border:1px solid #2b3350;color:var(--fg);padding:8px 10px;border-radius:12px;cursor: var(--cursor-normal);box-shadow:var(--glow);transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:#111726;border:1px solid #28304a;color:var(--muted)}

    .left{grid-area:left;background:var(--panel);border-right:1px solid #22283d;display:flex;flex-direction:column;min-height:0}
    .left .search{padding:10px;display:flex;gap:8px;align-items:center}
    .left input{flex:1;width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3350;background:#0f1422;color:var(--fg)}
    .catalog{padding:8px 10px;overflow:auto;display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .card{
      user-select:none;background:linear-gradient(180deg,#1b2233,#151b29);
      border:1px solid #2a3250;border-radius:14px;padding:10px;display:flex;
      flex-direction:column;align-items:center;gap:6px;box-shadow:var(--glow);
      cursor: inherit; touch-action: none;
    }
    .card.rare{outline:2px solid #b78cff; box-shadow:0 0 12px rgba(183,140,255,.45), var(--glow)}
    .card:active{cursor: inherit}
    .emoji{font-size:28px}
    .name{font-size:12px;color:#c7d0dd;text-align:center}

    .main{grid-area:main;position:relative;display:grid;grid-template-rows:1fr 220px}
    .board{position:relative;overflow:hidden}
    .dropzone{position:absolute;inset:0;display:grid;place-items:center;border:2px dashed #2a3250;border-radius:16px;margin:16px;background:linear-gradient(180deg,rgba(109,213,250,.08),rgba(127,83,172,.08)); cursor: var(--cursor-normal);}
    .dropzone .hint{opacity:.8;color:var(--muted)}

    .workspace{position:absolute;inset:0;margin:16px;border-radius:16px;pointer-events:none}
    .token{position:absolute;pointer-events:auto;transform:translate(-50%,-50%); transition: opacity 0.25s ease; cursor: inherit;}
    .token.fade-out { opacity: 0; }
    .token .card{padding:8px 10px}

    .combos{border-top:1px solid #22283d;background:#0e1423;overflow:auto}
    .combos h3{margin:10px 14px;font-size:13px;color:#aab4c8}
    .combo-log{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;padding:10px}
    .combo{background:#131a2b;border:1px solid #26304e;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .combo .mini{display:flex;align-items:center;gap:6px}
    .mini .emoji{font-size:18px}

    .right{grid-area:right;background:var(--panel);border-left:1px solid #22283d;display:flex;flex-direction:column;min-height:0}
    .right h3{margin:10px 14px;font-size:13px;color:#aab4c8}
    .book{padding:10px;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
    .panel{border-top:1px solid #22283d;background:#0e1423;padding:10px 12px;display:grid;gap:8px}
    .progress{height:8px;background:#0c1220;border:1px solid #26304e;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#6dd5fa,#7f53ac)}
    .missions{display:grid;gap:6px}
    .mission{display:flex;align-items:center;gap:8px;background:#11182a;border:1px solid #22304c;padding:6px 8px;border-radius:10px}
    .mission .done{opacity:.5;text-decoration:line-through}

    footer{grid-area:footer;border-top:1px solid #22283d;background:#0e1320;color:var(--muted);padding:8px 12px;display:flex;align-items:center;gap:10px}

    .toast{position:fixed;right:16px;bottom:16px;background:#0e1423;border:1px solid #2a3352;color:#eaf2ff;padding:10px 12px;border-radius:12px;box-shadow:var(--glow);opacity:0;transform:translateY(8px);transition:all .25s ease;z-index:99}
    .toast.show{opacity:1;transform:translateY(0)}
    .sparkle{position:absolute;font-size:18px;pointer-events:none;animation:spark .8s ease forwards}
    @keyframes spark{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}40%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-70%) scale(.3)}}
    .emoji {font-size: 28px;}

    /* Intro cutscene */
    .intro{position:fixed;inset:0;background:#000;color:#e9eef5;
      display:flex;align-items:center;justify-content:center;z-index:9999;
      opacity:1;transition:opacity .8s ease}
    .intro.hidden{display:none}
    .intro.fade{opacity:0}
    .intro-inner{position:relative;max-width:70ch;padding:32px 28px;
      font-size:18px;line-height:1.75;letter-spacing:.2px}
    .intro-text{white-space:pre-line;text-align:center}
    .intro .scan{pointer-events:none;position:absolute;inset:-8px;border-radius:8px;
      background:repeating-linear-gradient( to bottom,
        rgba(255,255,255,.045) 0, rgba(255,255,255,.045) 1px,
        transparent 2px, transparent 3px); mix-blend-mode:overlay;
      animation:introScan 7.5s linear infinite; opacity:.18}
    @keyframes introScan{from{transform:translateY(-100%)}to{transform:translateY(100%)}}
    .intro::after{
      content:"";
      position:absolute; inset:0; pointer-events:none; opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      animation:introNoise .25s steps(2) infinite;
    }

    /* Drag ghost for fake DnD */
    .drag-ghost{
      position: fixed; left: 0; top: 0; pointer-events: none; z-index: 99999;
      transform: translate(-50%,-50%);
    }

    /* ÊãñÊõ≥‰∏≠ÔºàÁî± JS ÂàáÊèõ .draggingÔºâ */
    .app.dragging, .app.dragging *{ cursor: var(--cursor-drag) !important; }
  </style>
</head>
<body>
  <audio id="introBgm" src="cosmic.wav" preload="auto"></audio>
  <div class="app">
    <header>
      <h1>Was that Infinite? <span class="pill">Local Prototype</span></h1>
      <div class="actions">
        <button id="exportBtn" title="ÂåØÂá∫Ë≥áÊñô">ÂåØÂá∫</button>
        <button id="importBtn" title="ÂåØÂÖ•Ë≥áÊñô">ÂåØÂÖ•</button>
        <button id="resetBtn" title="ÈáçÁΩÆÊâÄÊúâÈÄ≤Â∫¶" style="border-color:#4a2030">ÈáçÁΩÆ</button>
      </div>
    </header>

    <aside class="left">
      <div class="search">
        <input id="search" placeholder="ÊêúÂ∞ãÂü∫Á§éÂÖÉÁ¥†ÊàñÂ∑≤Ëß£ÈéñÁâ©ÂìÅ" />
        <span class="pill" id="statsPill">‚Äî</span>
      </div>
      <div id="catalog" class="catalog"></div>
    </aside>

    <main class="main">
      <section class="board">
        <div class="dropzone" id="dropzone"><div class="hint">ÊääÂÖ©ÂÄãÂç°ÁâáÊãñÈÄ≤‰æÜÂêàÊàê</div></div>
        <div class="workspace" id="workspace"></div>
      </section>
      <section class="combos">
        <h3>ÂêàÊàêÁ¥ÄÈåÑ</h3>
        <div id="comboLog" class="combo-log"></div>
      </section>
    </main>

    <aside class="right">
      <h3>Êî∂ÈõÜÂÜä</h3>
      <div id="book" class="book"></div>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong style="font-size:13px;color:#cfe2ff">ÈÄ≤Â∫¶</strong>
          <button id="rerollMissions" class="btn" style="padding:6px 8px;font-size:12px">ÈáçÊì≤‰ªªÂãô</button>
        </div>
        <div class="progress"><div id="progressBar" class="bar" style="width:0%"></div></div>
        <div class="missions" id="missions"></div>
      </div>
    </aside>

    <footer>
      <span>Êú¨Âú∞ÂÑ≤Â≠ò v8.2<span id="ver"></span> ‚Ä¢ ÂæåÁ´ØÈñãÁôº‰∏≠ ‚Ä¢ ÊîØÊè¥ new discover</span>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <!-- CUTSCENE: Intro -->
  <div id="intro" class="intro hidden">
    <div class="intro-inner">
      <div class="scan"></div>
      <div class="intro-text" id="introText"></div>
    </div>
  </div>

  <script>
    // ---------- Versioning ----------
    const SAVE_VERSION = 8.2;

    // ---------- Robust JSON helpers ----------
    function safeParseJSON(raw){
      try{
        if(raw == null) return {ok:true, val:null};
        if(typeof raw !== 'string') return {ok:false, err:'not-string'};
        const s = raw.trim();
        if(s === '' || s === 'null' || s === 'undefined') return {ok:true, val:null};
        return {ok:true, val: JSON.parse(s)};
      }catch(err){ return {ok:false, err}; }
    }

    function isPlainObject(o){ return Object.prototype.toString.call(o) === '[object Object]'; }

    function validateState(s){
      if(!s) return false;
      if(!isPlainObject(s.known) || !isPlainObject(s.unlocked) || !Array.isArray(s.history)) return false;
      if(!('version' in s)) s.version = 1; // migrate older saves
      if(!Array.isArray(s.missions)) s.missions = [];
      return true;
    }

    // ---------- Persistence Layer ----------
    const LS_KEY = 'iec_save_v1';
    function saveState(){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      catch(e){ console.warn('saveState failed', e); toast('ÂÑ≤Â≠òÂ§±ÊïóÔºöÈÖçÈ°çÊàñÁÄèË¶ΩÂô®ÈôêÂà∂'); }
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const parsed = safeParseJSON(raw);
        if(!parsed.ok){ console.warn('loadState: corrupted raw', parsed.err); return null; }
        const val = parsed.val;
        if(!validateState(val)) return null;
        // migrate
        if(val.version < SAVE_VERSION){ val.version = SAVE_VERSION; }
        return val;
      }catch(e){
        console.warn('loadState: exception, wipe bad save', e);
        try{ localStorage.removeItem(LS_KEY); }catch{ /* ignore */ }
        return null;
      }
    }

    // ---------- Data ----------
    const firstPool = [
      ['Ê∞¥',['üíß']], ['ÁÅ´',['üî•']], ['Âúü',['üü´']], ['È¢®',['üí®']]
    ];
    const seedRecipes = {
      'Ê∞¥+Âúü':['Ê≥•',['üü§']],
      'ÁÅ´+ÁÅ´':['ÁÉàÁÑ∞',['üî•','üî•']],
      'Ê∞¥+Ê∞¥':['Ê≤≥',['üíß','üåä']],
      'ÁÅ´+Ê∞¥':['Ëí∏Ê∞£',['üí®']],
      'È¢®+È¢®':['È¢∂È¢®',['üí®','üí®']],
      'ÊúàÁêÉ+Ê∞¥':['ÊúàÊ≥â',['üåï','üíß']],
      'Ê≤≥+Áü≥È†≠':['Ê≤ô',['üèúÔ∏è']],
      'Êµ∑+Ê®π':['ÁèäÁëö',['ü™∏']],
      'ÁÜîÁàê+ÈõúÈáëÂ±¨':['Á¥îÈáëÂ±¨',['‚öôÔ∏è']],
      'Ê∞¥+Ê≥•':['Ê≥•Êºø',['üü§','üíß']],
      'Ê∞¥+Ê≤ô':['Ê≥•Êºø',['üü§','üíß']],
      'È¢®+Ê≤ô':['Ê≤ôÂ°µÊö¥',['üí®','ü™®']],
      'ÁÅ´+ÁÖô':['ÁÅ∞Ááº',['üî•','üå´Ô∏è']],
      'ÁÅ∞Ááº+Ê∞¥':['ÁÅ∞Ê∞¥',['üå´Ô∏è','üíß']],  
      'ÁÅ∞Ááº+Âúü':['Ê≤ÉÂ£§',['üü´','‚ú®']],
      'Ê≤ÉÂ£§+Ê§çÁâ©':['‰ΩúÁâ©',['üåæ']],
      'Ê≤≥+Ê≤≥':['Êπñ',['üíß','üèûÔ∏è']],
      'Êπñ+Êπñ':['Êµ∑',['üåä']],
      'Ê≥•+ÂÖâ':['Á¥∞ËÉû',['ü¶†']],
      'Á¥∞ËÉû+Á¥∞ËÉû':['ÁîüÂëΩ',['üå±']],
      'ÈõúÈáëÂ±¨+È¢®':['Èõª',['‚ö°']],
      'È¢®+Ê≥•':['Ê≥•Ê≤ôÊö¥',['üí®','üü§']],
      'Á¥∞ËÉû+Ê∞¥':['Ê∞¥Á¥∞ËÉû',['ü¶†','üíß']],
      'Á¥∞ËÉû+Âúü':['ÂúüÁ¥∞ËÉû',['ü¶†','üü´']],
      'Á¥∞ËÉû+È¢®':['È¢®Á¥∞ËÉû',['ü¶†','üí®']],
      'Ê∞¥Ê≥•+Á£ö':['ÁâÜ',['üß±','üèóÔ∏è']],
      'Á¥∞ËÉû+ÁÅ´':['ÁÅ´Á¥∞ËÉû',['ü¶†','üî•']],
      'ÁÅ´+Âúü':['Á£ö',['üß±']],
      'ÁÅ´+Ê≥•':['ÈªèÂúü',['üü§','ü™®']],
      'ÁâÜ+Â§©Á©∫':['Â§©Ëä±Êùø',['üè†','‚¨ú']],
      'Â§©Ëä±Êùø+ÁâÜ':['ÊàøÈñì',['üè†','üö™']],
      'ÁÅ´+ÈªèÂúü':['Ê∞¥Ê≥•',['üß±','ü™®']],
      'Âúü+Âúü':['Áü≥È†≠',['ü™®']],
      'Áü≥È†≠+ÁÅ´':['ÈõúÈáëÂ±¨',['‚öôÔ∏è']],
      'È¢®+ÁÅ´':['ÁÖô',['üå´Ô∏è']],
      'È¢®+Ê∞¥':['Èõ≤',['‚òÅÔ∏è']],
      'Èõ≤+È¢®':['Â§©Á©∫',['üåà']],
      'Èõ≤+Èõª':['Èõ∑',['üå©Ô∏è']],
      'È¢®+Èõ®':['Êö¥Èõ®',['‚õàÔ∏è']],
      'Èõ≤+Ê∞¥':['Èõ®',['üåßÔ∏è']],
      'Â§©Á©∫+ÁÅ´':['Â§™ÈôΩ',['‚òÄÔ∏è']],
      'Â§©Á©∫+Èõª':['ÂÖâ',['‚ú®']],
      'Â§©Á©∫+ÂÖâ':['ÊúàÁêÉ',['üåï']],
      'Â§™ÈôΩ+ÊúàÁêÉ':['ÊôÇÈñì',['‚åõÔ∏è']],
      'ÁîüÂëΩ+Âúü':['Ê§çÁâ©',['üåø']],
      'Ê§çÁâ©+ÊôÇÈñì':['Ê®π',['üå≥']],
      'Èõª+Ê∞¥': ['ÈõªËß£Ê∞¥',['‚ö°','üíß']],
      'Ê§çÁâ©+Èõ®':['Ëä±Êúµ',['üå∏']],
      'Ê§çÁâ©+Ê∞¥':['Ê∞¥ÁîüÊ§çÁâ©',['üíß','üåø']],
      'ÈõúÈáëÂ±¨+Èõª':['‰ΩéÈöéÊ©üÂô®',['ü§ñ']],
      'Á¥îÈáëÂ±¨+Èõª':['È´òÈöéÊ©üÂô®',['ü§ñ']],
      'Ê∞¥+ÊôÇÈñì':['ÂÜ∞',['üßä']],
      'Ê∞¥+ÂÜ∞':['Èõ™',['‚ùÑÔ∏è']],
      'ÁÅ´+ÈõúÈáëÂ±¨':['ÁÜîÁàê',['üî•','üè≠']],
      'ÁîüÂëΩ+Ê∞¥':['È≠ö',['üêü']],
      'È≠ö+Èõª':['ÈõªÈ∞ª',['üêü','‚ö°']],
      'Âúü+ÊôÇÈñì':['ÂåñÁü≥',['ü¶¥']],
      'ÁîüÂëΩ+Á¥îÈáëÂ±¨':['Ë≥ΩÂçö',['üß¨','ü§ñ']]
    };

    const normPair = (a,b) => [a,b].sort().join('+');
    const seedMap = {};
    for (const [k, v] of Object.entries(seedRecipes)) {
      const [a, b] = k.split('+');
      seedMap[normPair(a, b)] = v;
    }
    const resultEmojiMap = {};
    for (const [k, v] of Object.entries(seedRecipes)) {
      const [name, emoji] = v;
      resultEmojiMap[name] = Array.isArray(emoji) ? emoji : [emoji];
    }

    const rules = [
      [/ÈªëÊ¥û|ÂÆáÂÆô|ÈäÄÊ≤≥|ÊòüÁ≥ª|Ë°åÊòü|ÊÅÜÊòü|Êòü|ÂΩóÊòü/, ['ü™ê']],
      [/Ê∞¥|Ê≥â|Èõ®|Êª¥/, ['üíß']],
      [/Êµ∑|ÊΩÆ|Êµ™|Ê¥ã/, ['üåä']],
      [/Ê≤≥|Êπñ/, ['üèûÔ∏è']],             
      [/Ê®π|Êûó|Êú®|Ê£Æ|Êùæ|Êüè/, ['üå≤']],
      [/Ëä±|Áì£|Ê´ª|Ê¢Ö|Ëèä|ËìÆ|Ëò≠/, ['üå∏']],
      [/Ëü≤|ÂπºËü≤/, ['üêõ']],
      [/Ëù∂/, ['ü¶ã']],
      [/Áî≤Ëü≤|Èç¨ÂΩ¢Ëü≤|ÈáëÈæúÂ≠ê/, ['ü™≤']],
      [/ËúÇ/, ['üêù']],
      [/ËûûËüª|Ëüª/, ['üêú']],
      [/Ëöä/, ['ü¶ü']],
      [/Áì¢Ëü≤/, ['üêû']],
      [/Á£Å|Á£ÅÈêµ|Á£ÅÂ†¥/, ['üß≤']],
      [/ÂÜ∞|ÁµêÂÜ∞/, ['üßä']],
      [/Èõ™|Èúú|ÂØí/, ['‚ùÑÔ∏è']], 
      [/ÁÅ´|ÁÇé|ÁÑ∞|ÁÜî|ÁÜ±|ÁÜæ|ÁáÑ/, ['üî•']],
      [/Èõª|Èõ∑|ÈñÉÈõª|ÈõªÊìä/, ['‚ö°']],
      [/Êûú|ËòãÊûú/, ['üçé']],
      [/Ëë°ËêÑ/, ['üçá']],
      [/È≥•|È∑π|Èöº/, ['ü¶Ö']],
      [/È¥®|Èµù|ÈõÅ/, ['ü¶Ü']],
      [/Ëõá|Ëüí/, ['üêç']],
      [/Èæú|Êµ∑Èæú/, ['üê¢']],
      [/Ëú•|Ëú•Ëú¥/, ['ü¶é']],
      [/Ëõô|ÈùíËõô|ËüæËúç/, ['üê∏']],
      [/È∂¥/, ['üê¶']],
      [/È¥ø/, ['üïäÔ∏è']],
      [/Èõû|Èõõ/, ['üêî']],
      [/Â≠îÈõÄ/, ['ü¶ö']],
      [/‰ºÅÈµù/, ['üêß']],
      [/Ëïâ/, ['üçå']],
      [/Ê©ô|Ê©ò|Êüë/, ['üçä']],
      [/Ëéì/, ['üçì']],
      [/È¢®|È¢∂|È£Ñ|Ê∞£|Èúß|ÁÖô/, ['üí®']],
      [/Âúü|Âú∞|Á†Ç|Áü≥|Â±±|Â≤©|Á§¶|Á£ö|Ê≥•|Â°µ/, ['ü™®']],
      [/ÈáëÂ±¨|Èáë|Èãº|Èêµ|ÈäÖ|ÈäÄ|Ê©ü|ÈΩí|Ê¢∞|Ë£ùÁî≤|Ë£ùÂÇô/, ['‚öôÔ∏è']],
      [/È¶¨|Èßí/, ['üêé']],
      [/Áâõ|Áä¢/, ['üêÇ']],
      [/Áæä|Áæî/, ['üêë']],
      [/Ë±¨|Ë±ö/, ['üêñ']],
      [/Áä¨|Áãó|ÁçµÁä¨|Áãº/, ['üê∫']],
      [/Ë≤ì|ÁçÖ|Ëôé|Ë±π/, ['üêà']],
      [/ÁÜä/, ['üêª']],
      [/Áå¥|Áåø/, ['üêí']],
      [/ËùôËù†/, ['ü¶á']],
      [/ÂÖî/, ['üêá']],
      [/Ë±°|Èï∑Èºª/, ['üêò']],
      [/ÊôÇÈñì|ÊôÇ|Èêò|Ê≠≤|Âè§|ÂåñÁü≥|Á¥ÄÂÖÉ|Áßí|ÂàÜ/, ['‚åõÔ∏è']],
      [/Èæç|Áç∏|ÊÄ™|Á•û/, ['üêâ']],
      [/ÊÄ™Áç∏|Â∑®ÊÄ™|Â¶ñ/, ['üëπ']],
      [/È≥≥Âá∞|È≥≥/, ['üê¶‚Äçüî•']],
      [/È≠ö/, ['üêü']],
      [/ÈØä/, ['ü¶à']],
      [/ÈØ®/, ['üêã']],
      [/Êµ∑Ë±ö/, ['üê¨']],
      [/Á´†È≠ö/, ['üêô']],
      [/È≠∑/, ['ü¶ë']],
      [/Ëù¶/, ['ü¶ê']],
      [/Ëüπ/, ['ü¶Ä']],
      [/Êµ∑Êòü/, ['‚≠ê']],
      [/Â∑´|Ê≥ïÂ∏´/, ['üßôüèª']],
      [/Èùà|È≠Ç|È≠Ñ/, ['üëª']],
      [/È≠î|Âíí|Âπª|Ë°ì|Ê≥ï|Á¨¶/, ['ü™Ñ']],
      [/Áîü|ÁîüÂëΩ|Ê§çÁâ©|Ëçâ|ËäΩ|Ëó§|Ëëâ|Ëãó/, ['üå±']],
      [/Âäç|ÂàÄ|ÂàÉ|Áü≠Âäç|Èï∑Âäç|ÂåïÈ¶ñ|Ê≠¶Â£´ÂàÄ|ÈõôÂàÄ|Â∑®Âäç/, ['üó°Ô∏è']],
      [/Êñß|Êà∞Êñß|ÊâãÊñß|ÈõôÂàÉÊñß/, ['ü™ì']],
      [/Èéö|Èåò|Êà∞Èåò|Â§ßÈéö|Ê¶îÈ†≠/, ['üî®']],
      [/Âºì|ÂºìÁÆ≠|Èï∑Âºì|Áü≠Âºì|Âº©|ÂçÅÂ≠óÂºì/, ['üèπ']],
      [/Áüõ|Èï∑Êßç|Èï∑Áüõ|Ê®ôÊßç|Êàü|ÊßçÂàÉ/, ['üó°Ô∏è']],
      [/Áõæ|Èò≤Áõæ|Ë≠∑Áõæ/, ['üõ°Ô∏è']],
      [/È£õÈè¢|ÊâãË£°Âäç|Êì≤Êñß|ÊäïÁü≥/, ['üéØ']],
      [/ÊâãÊßç|Ê≠•Êßç|ÁãôÊìäÊßç|ÁçµÊßç|Èú∞ÂΩàÊßç|ÊßçÊ¢∞/, ['üî´']],
      [/Á†≤|ÁÇÆ|ÁÅ´Á†≤|Â§ßÁ†≤|Âä†Ëæ≤ÁÇÆ|Ëø´ÊìäÁ†≤/, ['üí£']],
      [/Èé¨|Á®ø|Èé¨Â≠ê|ÂçÅÂ≠óÈé¨|ÊåñÁ§¶/, ['‚õèÔ∏è']],
      [/Èèü|ÈêµÈç¨|ÈêµÈèü|ÈèüÂ≠ê|Èç¨/, ['üßπ']],
      [/Èã∏|Èã∏Â≠ê/, ['ü™ö']],
      [/Êâ≥Êâã|ÊùøÊâã|Â•óÁ≠í|Ê¢ÖËä±Êâ≥Êâã/, ['üîß']],
      [/Ëû∫Áµ≤Ëµ∑Â≠ê|Ëµ∑Â≠ê|Ëû∫Ëµ∑/, ['ü™õ']],
      [/Â∑•ÂÖ∑ÁÆ±|Â∑•ÂÖ∑ÂåÖ/, ['üß∞']],
    ];
    const emojiPool = ['ü™ê','‚ú®','üß™','üß≤','üß†','üé≤','üßØ','üõ∞Ô∏è','ü™Ñ','üì¶','üõ∏','üß∞','üéá','üîÆ','üóø','üßä','üß±','üåã','üå™Ô∏è','üåä','üåå','üåà','ü™µ','üçû','ü•ö','üç∞','üç´','‚òÇÔ∏è','üé∫','‚öóÔ∏è','üßµ','üß∑','üß´','ü™§','üì°','üîß','üß≠'];
    function pickEmojiByName(name) {
      if (!name) return [randomFrom(emojiPool)];
      name = String(name).toLowerCase();
      const found = [];
      for (const [re, arr] of rules) {
        if (found.length >= 3) break;
        if (re.test(name)) {
          const emo = Array.isArray(arr) ? arr[0] : arr;
          if (!found.includes(emo)) found.push(emo);
        }
      }
      return found.length ? found : [randomFrom(emojiPool)];
    }
    function randomFrom(arr) { return arr && arr.length ? arr[Math.floor(Math.random() * arr.length)] : '‚ùì'; }

    function generateName(a,b){
      const classify = n => {
        if(/ÁÅ´|ÁÑ∞|ÁÜî|ÁÜ±/.test(n)) return 'fire';
        if(/Ê∞¥|Êµ∑|Ê≤≥|ÂÜ∞|Èõ≤|Èõ®|Èúú/.test(n)) return 'water';
        if(/È¢®|Ê∞£|Èõ≤|Èúß|ÁÖô/.test(n)) return 'wind';
        if(/Âúü|Áü≥|Â±±|Â≤©|Á§¶|Á£ö|Ê≥•/.test(n)) return 'earth';
        if(/Èæç|Áç∏|È≥•|È≠ö|Ëü≤/.test(n)) return 'creature';
        if(/Èáë|Èãº|Èêµ|Ê©ü|ÈΩí|Ê¢∞/.test(n)) return 'tech';
        return 'other';
      };
      const ca = classify(a), cb = classify(b);
      let name;
      if(a === b){
        const prefix = ca==='creature' ? 'Èõô' : 'Èõô';
        name = prefix + a;
      } else if((ca==='tech' && cb==='creature') || (cb==='tech' && ca==='creature')){
        name = 'Ë≥ΩÂçö' + (ca==='creature'? a : b);
      } else {
        const templates = [
          `${a}${b}`, `${a}‰πã${b}`, `${b}-${a}`, `${a} ${b}`, `${a}${b}È´î`, `${a}¬∑${b}`
        ];
        name = templates[Math.floor(Math.random()*templates.length)];
      }
      return name
        .replace(/(.)\1\1+/g, '$1$1')
        .replace(/(ÁÅ´)ÁÅ´/g, 'ÈõôÁÅ´')
        .replace(/(Ê∞¥)Ê∞¥/g, 'ÈõôÊ∞¥');
    }
    function isApplePlatform() { return /Mac|iPhone|iPad|iPod/i.test(navigator.userAgent); }

    // emoji ÂúñÁâáÂø´Âèñ
    const emojiImgCache = new Map();

    function makeCard(name, emojis, rare = false) {
      const list = Array.isArray(emojis) ? emojis : [emojis];
      const el = document.createElement('div');
      el.className = 'card';
      el.draggable = false; // ÈóúÊéâÂéüÁîü DnD
      el.dataset.name = name;

      const emojiContainer = document.createElement('div');
      emojiContainer.className = 'emoji-container';

      list.forEach(emoji => {
        const emojiEl = document.createElement('div');
        emojiEl.className = 'emoji';

        if (isApplePlatform()) {
          emojiEl.textContent = emoji;
        } else {
          let imgNode;
          if (emojiImgCache.has(emoji)) {
            imgNode = emojiImgCache.get(emoji).cloneNode(true);
          } else {
            const img = document.createElement('img');
            img.src = `https://emojicdn.elk.sh/${encodeURIComponent(emoji)}?style=apple&size=64`;
            img.alt = emoji;
            img.width = 28;
            img.height = 28;
            emojiImgCache.set(emoji, img);
            imgNode = img.cloneNode(true);
          }
          emojiEl.appendChild(imgNode);
        }

        emojiContainer.appendChild(emojiEl);
      });

      el.appendChild(emojiContainer);

      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.textContent = name;
      el.appendChild(nameEl);

      return el;
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(t._h); t._h = setTimeout(()=>t.classList.remove('show'), 1850);
    }

    function spark(x,y,container){
      for(let i=0;i<6;i++){
        const s = document.createElement('div');
        s.className = 'sparkle'; s.textContent = '‚ú®';
        s.style.left = x + (Math.random()*60-30) + 'px';
        s.style.top  = y + (Math.random()*30-10) + 'px';
        container.appendChild(s);
        setTimeout(()=>s.remove(), 900);
      }
    }
    function playClick(){
      try {
        const audio = new Audio('click.ogg');
        audio.play().catch(err => console.warn('click Èü≥ÊïàÊí≠ÊîæË¢´ÈòªÊìã', err));
      } catch (err) {
        console.warn('Êí≠Êîæ click.ogg Â§±Êïó', err);
      }
    }

    // ---------- State ----------
    let state = loadState() || {
      version: SAVE_VERSION,
      known: {},
      unlocked: {},
      history: [],
      missions: []
    };

    // seed base
    for(const [n,e] of firstPool){ state.unlocked[n] = state.unlocked[n] || e; }
    if(!state.missions || state.missions.length===0) regenMissions();
    saveState();

    // ---------- UI Rendering ----------
    const catalogEl = document.getElementById('catalog');
    const bookEl = document.getElementById('book');
    const comboLogEl = document.getElementById('comboLog');
    const workspace = document.getElementById('workspace');
    const dropzone = document.getElementById('dropzone');
    const missionsEl = document.getElementById('missions');
    const progressBar = document.getElementById('progressBar');
    const statsPill = document.getElementById('statsPill');
    const searchEl = document.getElementById('search');

    function updateMissionProgress(){
      const total = state.missions.length || 0;
      const done = state.missions.filter(m => m.done).length;
      const pct = total ? Math.round(done / total * 100) : 0;
      progressBar.style.width = pct + '%';
      progressBar.setAttribute('aria-valuenow', pct);
    }

    function fuzzyMatch(hay, needle){
      if(!needle) return true;
      const s = hay.toLowerCase();
      const n = needle.toLowerCase().trim();
      if(s.includes(n)) return true;
      let i=0; for(const ch of s){ if(ch===n[i]) i++; if(i===n.length) return true; }
      return false;
    }

    function renderCatalog(filter=''){
      catalogEl.innerHTML = '';
      const items = Object.entries(state.unlocked).map(([n,e])=>({n,e}))
        .filter(x=>fuzzyMatch(x.n, filter))
        .sort((a,b)=>a.n.localeCompare(b.n,'zh-Hant'));
      const frag = document.createDocumentFragment();
      for(const it of items){
        const c = makeCard(it.n,it.e);
        c.addEventListener('pointerdown', ev=>{
          startFakeDrag(ev, {name: it.n, emoji: it.e});
        });
        frag.appendChild(c);
      }
      catalogEl.appendChild(frag);
      const total = Object.keys(state.unlocked).length;
      statsPill.textContent = `${total} È†Ö`;
    }

    function renderBook(){
      bookEl.innerHTML = '';
      const entries = Object.entries(state.unlocked).sort((a,b)=>a[0].localeCompare(b[0],'zh-Hant'));
      const frag = document.createDocumentFragment();
      for(const [n,e] of entries){
        const c = makeCard(n,e);
        c.style.cursor='default'; c.draggable=false;
        frag.appendChild(c);
      }
      bookEl.appendChild(frag);
    }

    function renderHistory(){
      comboLogEl.innerHTML='';
      const frag = document.createDocumentFragment();
      for(const h of state.history.slice(-120).reverse()){
        const row = document.createElement('div');
        row.className='combo';
        row.innerHTML = `
          <div class="mini"><div class="emoji">${h.a.emoji.join('')}</div><div class="name">${h.a.name}</div></div>
          <div>+</div>
          <div class="mini"><div class="emoji">${h.b.emoji.join('')}</div><div class="name">${h.b.name}</div></div>
          <div>=</div>
          <div class="mini"><div class="emoji">${h.res.emoji.join('')}</div><div class="name">${h.res.name}</div></div>
        `;
        frag.appendChild(row);
      }
      comboLogEl.appendChild(frag);
    }

    function renderMissions(){
      missionsEl.innerHTML = '';
      for(const m of state.missions){
        const row = document.createElement('div');
        row.className = 'mission';
        row.innerHTML = `<div class="emoji">${m.emoji.join('')}</div><div class="name ${m.done?'done':''}">${m.name}</div>`;
        missionsEl.appendChild(row);
      }
      updateMissionProgress(); 
    }

    function getAllElementNames(){
      const set = new Set();
      for (const r of Object.values(seedRecipes)) {
        if (Array.isArray(r) && typeof r[0] === 'string') set.add(r[0]);
      }
      for (const k in (state.known || {})) {
        const r = state.known[k];
        if (r && typeof r.name === 'string') set.add(r.name);
      }
      return [...set];
    }

    function eligibleMissionPool(){
      const unlocked = new Set(Object.keys(state.unlocked || {}));
      const current  = new Set((state.missions || []).map(m => m.name));
      return getAllElementNames().filter(n => !unlocked.has(n) && !current.has(n));
    }

    function pickEligibleMission(){
      const pool = eligibleMissionPool();
      if (!pool.length) return null;
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function regenMissions(count = 3, { force = false } = {}) {
      state.missions = Array.isArray(state.missions) ? state.missions : [];
      state.missions = force ? [] : state.missions.filter(m => m && !m.done);
      let added = 0;
      while (state.missions.length < count) {
        const next = pickEligibleMission();
        if (!next) break;
        state.missions.push({
          name: next,
          emoji: Array.isArray(state.unlocked[next]) ? state.unlocked[next]
               : (resultEmojiMap[next] || pickEmojiByName(next)),
          done: false
        });
        added++;
      }
      return added;
    }

    // ---------- Reset Logic ----------
    function hardReset(){
      try {
        localStorage.setItem(LS_KEY, '');
        localStorage.removeItem(LS_KEY);
      } catch {}
      state = {
        version: SAVE_VERSION,
        known: {},
        unlocked: {},
        history: [],
        missions: []
      };
      for (const [n, e] of firstPool) { state.unlocked[n] = e; }
      regenMissions();
      saveState();
      try { document.getElementById('workspace').innerHTML = ''; } catch {}
      renderAll();
      toast('Â∑≤ÈáçÁΩÆ');
      try { localStorage.removeItem('iec_seen_intro_v2'); } catch {}
    }

    // ---------- Fake Drag & Drop (Âèñ‰ª£ÂéüÁîü) ----------
    let pending = []; // ËàáÂéüÊú¨ combine ÊµÅÁ®ãÂÖ±Áî®
    let dragging = null; // { data, ghostEl }
    const appEl = document.querySelector('.app');

    function startFakeDrag(e, data){
      e.preventDefault();
      const g = document.createElement('div');
      g.className = 'drag-ghost';
      g.appendChild(makeCard(data.name, data.emoji));
      document.body.appendChild(g);

      dragging = { data, ghostEl: g };
      appEl.classList.add('dragging');
      updateGhost(e.clientX, e.clientY);

      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp, { once: true });
    }

    function onMove(e){
      if(!dragging) return;
      updateGhost(e.clientX, e.clientY);
    }

    function updateGhost(x, y){
      if(!dragging) return;
      const g = dragging.ghostEl;
      g.style.left = x + 'px';
      g.style.top  = y + 'px';
    }

    function onUp(e){
      if(!dragging) return;
      const { data, ghostEl } = dragging;
      const inDrop = isInside(dropzone, e.clientX, e.clientY);

      ghostEl.remove();
      dragging = null;
      appEl.classList.remove('dragging');
      window.removeEventListener('pointermove', onMove);

      if(!inDrop) return;

      const rect = workspace.getBoundingClientRect();
      spawnToken(data.name, data.emoji, e.clientX - rect.left, e.clientY - rect.top);

      pending.push(data);
      if(pending.length>=2){
        const [a,b] = pending.splice(0,2);
        combine(a,b, e.clientX - rect.left, e.clientY - rect.top);
      }
    }

    function isInside(el, cx, cy){
      const r = el.getBoundingClientRect();
      return cx >= r.left && cx <= r.right && cy >= r.top && cy <= r.bottom;
    }

    function spawnToken(name, emoji, x,y){
      const t = document.createElement('div');
      t.className='token'; t.style.left=x+'px'; t.style.top=y+'px';
      t.appendChild(makeCard(name,emoji));
      workspace.appendChild(t);
      return t;
    }

    function combine(a,b,x,y){
      document.querySelectorAll('.token').forEach(el => el.remove());

      if (!Array.isArray(a.emoji)) a.emoji = [a.emoji];
      if (!Array.isArray(b.emoji)) b.emoji = [b.emoji];

      const key = normPair(a.name,b.name);
      let res = state.known[key];
      let isNew = false; let rare = false;

      if (!res) {
        const seed = seedMap[key];
        if (seed) {
          const [name, emoji] = seed;
          res = { name, emoji };
        }
      }

      if(!res){
        const name = generateName(a.name,b.name);
        const emoji = pickEmojiByName(name);
        res = {name, emoji};
      }

      state.known[key] = res;
      if(!state.unlocked[res.name]){ state.unlocked[res.name]=res.emoji; isNew = true; }
      rare = Math.random()<0.06;

      const productToken = spawnToken(
        res.name,
        res.emoji,
        x + (Math.random() * 40 - 20),
        y + (Math.random() * 20 - 10)
      );
      spark(x,y,workspace);
      setTimeout(() => { if (productToken) productToken.classList.add('fade-out'); }, 1450);
      setTimeout(() => { if (productToken) productToken.remove(); }, 1700);

      state.history.push({a,b,res});

      for (const m of state.missions) {
        if (!m.done && m.name === res.name) {
          m.done = true;
          toast(`‰ªªÂãôÂÆåÊàêÔºö${m.name} ${m.emoji.join('')}`);
        }
      }
      const allDone = state.missions.length > 0 && state.missions.every(m => m.done);
      if (allDone) { regenMissions(); }

      saveState();
      renderBook(); renderHistory(); renderCatalog(searchEl.value.trim()); renderMissions();

      try {
        const audio = new Audio('newthing.flac');
        audio.play().catch(err => console.warn('Èü≥ÊïàÊí≠ÊîæË¢´ÈòªÊìã', err));
      } catch (err) {
        console.warn('Êí≠Êîæ newthing.flac Â§±Êïó', err);
      }
      toast(isNew? `New DiscoverÔºö${res.name} ${res.emoji.join('')}` : `ÂêàÊàêÊàêÂäüÔºö${res.name} ${res.emoji.join('')}`);
    }

    // ---------- Controls ----------
    function debounce(fn, ms){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), ms); }; }
    searchEl.addEventListener('input', debounce(()=>{ renderCatalog(searchEl.value.trim()); }, 80));

    document.getElementById('rerollMissions').addEventListener('click', ()=>{
      const added = regenMissions(3, { force: true });
      saveState();
      renderMissions();
      toast(added > 0 ? 'Â∑≤ÈáçÊì≤‰ªªÂãô' : 'Ê≤íÊúâÂèØÈáçÊì≤ÁöÑ‰ªªÂãô');
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      playClick();
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='iec_save.json'; a.click(); URL.revokeObjectURL(url);
      toast('Â∑≤ÂåØÂá∫Â≠òÊ™î');
    });

    document.getElementById('importBtn').addEventListener('click', ()=>{
      playClick();
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = ev => {
        const f = ev.target.files[0]; if(!f) return;
        const reader = new FileReader(); reader.onload = () => {
          const parsed = safeParseJSON(reader.result);
          if(!parsed.ok){ toast('ËÆÄÂèñÂ§±ÊïóÔºöJSON Ê†ºÂºèÈåØË™§'); return; }
          const obj = parsed.val;
          if(validateState(obj)){ state = obj; saveState(); renderAll(); toast('ÂåØÂÖ•ÊàêÂäü'); }
          else toast('Ê†ºÂºèÈåØË™§ÊàñÁº∫Â∞ëÂøÖË¶ÅÊ¨Ñ‰Ωç');
        }; reader.readAsText(f);
      };
      inp.click();
    });

    (function installReset(){
      const resetBtn = document.getElementById('resetBtn');
      let armTimer = null;
      const disarm = () => {
        if(!resetBtn) return;
        resetBtn.dataset.armed = '';
        resetBtn.classList.remove('armed');
        if(resetBtn._oldText) resetBtn.textContent = resetBtn._oldText;
      };
      const arm = () => {
        resetBtn._oldText = resetBtn.textContent;
        resetBtn.dataset.armed = '1';
        resetBtn.classList.add('armed');
        resetBtn.textContent = 'ÂÜçÊåâ‰∏ÄÊ¨°Á¢∫Ë™çÈáçÁΩÆ';
        toast('ÂÜçÊ¨°ÈªûÊìä‰ª•Á¢∫Ë™çÈáçÁΩÆ');
        clearTimeout(armTimer);
        armTimer = setTimeout(disarm, 3500);
      };
      resetBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        playClick();
        if(!resetBtn.dataset.armed){ arm(); return; }
        clearTimeout(armTimer); disarm(); hardReset();
      });
      resetBtn.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); resetBtn.click(); }
        playClick();
      });
    })();

    function renderAll(){
      renderCatalog(); renderBook(); renderHistory(); renderMissions();
      document.getElementById('ver').textContent = SAVE_VERSION;
    }
    try{ renderAll(); } catch(e){ console.error('render error', e); toast('ÂàùÂßãÂåñÂ§±Êïó'); }

    // --- Opening Cutscene: "Was that Infinite?" v1.1 ---
    (function installOpening(){
      const INTRO_KEY = 'iec_seen_intro_v2';
      try { if (localStorage.getItem(INTRO_KEY)) return; } catch {}
      const intro   = document.getElementById('intro');
      const textEl  = document.getElementById('introText');
      if(!intro || !textEl) return;

      const frames = [
        { t: 'Âú®Âæà‰πÖ‰ª•ÂæåÁöÑÊüêÂ§©Ôºå‰∏ÄÂÄãÈ´òÁ≠âÊñáÊòéÁöÑÂØ¶È©óÂÆ§Ë£°ÔºåÊüêÊ¨°‰∏çË©≤Â§±ÊïóÁöÑÁ∂≠Â∫¶Â±ïÈñãÂØ¶È©óÂ§±Êïó‰∫Ü„ÄÇ', hold: 2500 },
        { t: 'Êï¥ÂÄã‰∏âÁ¥öÁ∂≠Â∫¶ÂÆáÂÆôË¢´Â£ìÁ∏ÆÁÇ∫ÁÑ°Êï∏ÁöÑ„ÄåÂÖÉÁ¥†„Äç„ÄÇ', hold: 2500 },
        { t: '‰Ω†ÂíåÈÄôÈñìÁ†¥Á¢éÁöÑÂØ¶È©óÂÆ§ÊòØÂîØ‰∏ÄÊ≤íË¢´ÂåñÁÇ∫ÂÖÉÁ¥†ÁöÑÂØ¶È´îÁâ©Ë≥™„ÄÇ', hold: 2500 },
        { t: '‰Ω†ÂøÖÈ†à‰∏çÊñ∑ÂêàÊàêÔºåÈáçÊñ∞ÊãºÂõûÁ∂≠Â∫¶ËàáÂÆáÂÆô„ÄÇ', hold: 2500 },
        { t: 'ÂêàÊàêÊ©üÔºèÊìç‰Ωú‰ªãÈù¢„ÄÄÈÄ£Á∑ö‰∏≠‚Ä¶', hold: 2500 },
        { t: 'ËºâÂÖ•Âü∫Á§éÂÖÉÁ¥†‚Ä¶‚Ä¶‚Ä¶ËºâÂÖ•ÂÆåÊàê„ÄÇ', hold: 2500 },
        { t: 'Ê∫ñÂÇôÂ∞±Á∑í„ÄÇ', hold: 2500 },
      ];
      const bgm = document.getElementById('introBgm');

      function playBgm(){
        if (!bgm) return;
        bgm.currentTime = 0; bgm.volume = 0;
        bgm.play().catch(()=>{});
        let v = 0;
        const fade = setInterval(()=>{
          v += 0.05;
          if(v >= 0.4){ v = 0.4; clearInterval(fade); }
          bgm.volume = v;
        }, 120);
      }

      function stopBgm(){
        if (!bgm) return;
        let v = bgm.volume;
        const fade = setInterval(()=>{
          v -= 0.05;
          if(v <= 0){ v = 0; clearInterval(fade); bgm.pause(); }
          bgm.volume = v;
        }, 120);
      }

      function typeLine(str, speed = 65){
        return new Promise(resolve=>{
          let i = 0, out = '';
          const id = setInterval(()=>{
            out += str[i++];
            textEl.textContent = out;
            if(i >= str.length){
              clearInterval(id);
              resolve();
            }
          }, speed);
        });
      }

      function showOverlay(){
        intro.classList.remove('hidden');
        void intro.offsetHeight;
        intro.classList.remove('fade');
      }

      function hideOverlay(){
        intro.classList.add('fade');
        setTimeout(()=> intro.classList.add('hidden'), 750);
      }

      (async function run(){
        playBgm();
        showOverlay();
        try {
          const hint = document.createElement('div');
          hint.style.position='absolute';
          hint.style.bottom='18px';
          hint.style.left='50%';
          hint.style.transform='translateX(-50%)';
          hint.style.fontSize='12px';
          hint.style.opacity='.65';
          intro.querySelector('.intro-inner')?.appendChild(hint);
        } catch {}

        for(const f of frames){
          await typeLine(f.t);
          await new Promise(r=> setTimeout(r, f.hold||800));
          textEl.textContent = textEl.textContent + '\n';
        }
        try { localStorage.setItem(INTRO_KEY, '1'); } catch {}
        hideOverlay();
        stopBgm();
      })();
    })();

  </script>
</body>
</html>
